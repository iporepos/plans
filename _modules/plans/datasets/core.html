
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>plans.datasets.core &#8212; plans 1.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/plans/datasets/core';</script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
    
    <img src="https://github.com/iporepos/plans-assets/blob/main/docs/figs/logo.jpg?raw=true" class="logo__image only-light" alt=""/>
    <img src="https://github.com/iporepos/plans-assets/blob/main/docs/figs/logo.jpg?raw=true" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">plans</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../index.html">
    Home
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../about.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../development.html">
    Development
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/iporepos/plans" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../index.html">
    Home
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../about.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../userguide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../development.html">
    Development
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/iporepos/plans" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">plans.datasets.core</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for plans.datasets.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-License-Identifier: GPL-3.0-or-later</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2025 The Project Authors</span>
<span class="c1"># See pyproject.toml for authors/maintainers.</span>
<span class="c1"># See LICENSE for license details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Primitive classes for handling datasets.</span>

<span class="sd">Overview</span>
<span class="sd">--------</span>

<span class="sd"># todo [docstring] -- overview</span>
<span class="sd">Mauris gravida ex quam, in porttitor lacus lobortis vitae.</span>
<span class="sd">In a lacinia nisl. Pellentesque habitant morbi tristique senectus</span>
<span class="sd">et netus et malesuada fames ac turpis egestas.</span>

<span class="sd">Example</span>
<span class="sd">-------</span>

<span class="sd"># todo [docstring] -- examples</span>
<span class="sd">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span>
<span class="sd">Nulla mollis tincidunt erat eget iaculis. Mauris gravida ex quam,</span>
<span class="sd">in porttitor lacus lobortis vitae. In a lacinia nisl.</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import numpy as np</span>
<span class="sd">    print(&quot;Hello World!&quot;)</span>

<span class="sd">Mauris gravida ex quam, in porttitor lacus lobortis vitae.</span>
<span class="sd">In a lacinia nisl. Mauris gravida ex quam, in porttitor lacus lobortis vitae.</span>
<span class="sd">In a lacinia nisl.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># IMPORTS</span>
<span class="c1"># ***********************************************************************</span>
<span class="c1"># import modules from other libs</span>

<span class="c1"># Native imports</span>
<span class="c1"># =======================================================================</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">glob</span><span class="o">,</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="c1"># ... {develop}</span>

<span class="c1"># External imports</span>
<span class="c1"># =======================================================================</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxNLocator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>

<span class="c1"># ... {develop}</span>

<span class="c1"># Project-level imports</span>
<span class="c1"># =======================================================================</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plans.root</span><span class="w"> </span><span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">DataSet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plans.analyst</span><span class="w"> </span><span class="kn">import</span> <span class="n">Univar</span><span class="p">,</span> <span class="n">GeoUnivar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">viewer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">geo</span>

<span class="c1"># ... {develop}</span>


<span class="c1"># CONSTANTS</span>
<span class="c1"># ***********************************************************************</span>
<span class="c1"># define constants in uppercase</span>

<span class="c1"># CONSTANTS -- Project-level</span>
<span class="c1"># =======================================================================</span>
<span class="n">DC_NODATA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;byte&quot;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># categorical/boolean maps</span>
    <span class="s2">&quot;uint8&quot;</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>  <span class="c1"># categorical/boolean maps</span>
    <span class="s2">&quot;uint16&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># zone maps</span>
    <span class="s2">&quot;float16&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">99999</span><span class="p">,</span>  <span class="c1"># fuzzy maps</span>
    <span class="s2">&quot;float32&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">99999</span><span class="p">,</span>  <span class="c1"># scientific maps</span>
<span class="p">}</span>
<span class="c1"># ... {develop}</span>


<span class="c1"># CONSTANTS -- Module-level</span>
<span class="c1"># =======================================================================</span>
<span class="c1"># ... {develop}</span>


<span class="c1"># FUNCTIONS</span>
<span class="c1"># ***********************************************************************</span>

<span class="c1"># FUNCTIONS -- Project-level</span>
<span class="c1"># =======================================================================</span>


<div class="viewcode-block" id="dataframe_prepro">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.dataframe_prepro">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dataframe_prepro</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function for dataframe pre-processing.</span>

<span class="sd">    :param dataframe: incoming dataframe</span>
<span class="sd">    :type dataframe: :class:`pandas.DataFrame`</span>
<span class="sd">    :return: prepared dataframe</span>
<span class="sd">    :rtype: :class:`pandas.DataFrame`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># fix headings</span>
    <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># strip string fields</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
        <span class="c1"># if data type is string</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;base_object&quot;</span><span class="p">:</span>
            <span class="c1"># strip all data</span>
            <span class="n">dataframe</span><span class="p">[</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span>
                <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dataframe</span></div>



<div class="viewcode-block" id="get_colors">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.get_colors">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_colors</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;tab20&quot;</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function to get a list of random colors</span>

<span class="sd">    :param size: Size of list of colors</span>
<span class="sd">    :type size: int</span>
<span class="sd">    :param cmap: Name of matplotlib color map (cmap)</span>
<span class="sd">    :type cmap: str</span>
<span class="sd">    :return: list of random colors</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>

    <span class="c1"># Choose a colormap from matplotlib</span>
    <span class="n">_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
    <span class="c1"># Generate a list of random numbers between 0 and 1</span>
    <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
        <span class="n">_lst_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_lst_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="c1"># Use the colormap to convert the random numbers to colors</span>
    <span class="n">_lst_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcolors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">_cmap</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_lst_vals</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">_lst_colors</span></div>



<span class="c1"># FUNCTIONS -- Module-level</span>
<span class="c1"># =======================================================================</span>
<span class="c1"># ... {develop}</span>


<span class="c1"># CLASSES</span>
<span class="c1"># ***********************************************************************</span>

<span class="c1"># CLASSES -- Project-level</span>
<span class="c1"># =======================================================================</span>

<span class="c1"># Chronological classes</span>
<span class="c1"># -----------------------------------------------------------------------</span>


<div class="viewcode-block" id="TimeSeries">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimeSeries</span><span class="p">(</span><span class="n">Univar</span><span class="p">):</span>
    <span class="c1"># todo docstring</span>

    <span class="c1"># Dunder methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="TimeSeries.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MyTimeSeries&quot;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;TS0&quot;</span><span class="p">):</span>
        <span class="c1"># ------------ set defaults ----------- #</span>

        <span class="c1"># upstream setups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span> <span class="o">=</span> <span class="s2">&quot;datetime&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agg</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;Dark2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_alias</span> <span class="o">=</span> <span class="s2">&quot;TS&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rawcolor</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span>  <span class="c1"># alternativa color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_src</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ------------ call super ----------- #</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>

        <span class="c1"># overwriters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>  <span class="c1"># overwrite from super</span>

        <span class="c1"># descriptors:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datarange_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datarange_max</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># --- auto update info</span>
        <span class="c1"># todo refactor names here later on --- why?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtres</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_standard</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gapsize</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_n</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eva</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># incoming data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_input</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># todo rename to file_data??</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_data_dtfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_data_varfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span></div>

        <span class="c1"># ... continues in downstream objects ... #</span>

    <span class="c1"># Core internal methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="TimeSeries._set_fields">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries._set_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set catalog fields names. Expected to increment superior methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ------------ call super ----------- #</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_fields</span><span class="p">()</span>

        <span class="c1"># TimeSeries fields</span>
        <span class="c1"># todo evaluate to make this fields snakecase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_field</span> <span class="o">=</span> <span class="s2">&quot;code&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_field</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_field</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">varfield_field</span> <span class="o">=</span> <span class="s2">&quot;VarField&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varname_field</span> <span class="o">=</span> <span class="s2">&quot;VarName&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varalias_field</span> <span class="o">=</span> <span class="s2">&quot;VarAlias&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datarange_min_field</span> <span class="o">=</span> <span class="s2">&quot;VarRange_min&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datarange_max_field</span> <span class="o">=</span> <span class="s2">&quot;VarRange_max&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_min_field</span> <span class="o">=</span> <span class="s2">&quot;Var_min&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_max_field</span> <span class="o">=</span> <span class="s2">&quot;Var_max&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dtfield_field</span> <span class="o">=</span> <span class="s2">&quot;DtField&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq_field</span> <span class="o">=</span> <span class="s2">&quot;DtFreq&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtres_field</span> <span class="o">=</span> <span class="s2">&quot;DtRes&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_field</span> <span class="o">=</span> <span class="s2">&quot;Start&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_field</span> <span class="o">=</span> <span class="s2">&quot;End&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">isstandard_field</span> <span class="o">=</span> <span class="s2">&quot;IsStandard&quot;</span>

        <span class="c1"># Epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gapsize_field</span> <span class="o">=</span> <span class="s2">&quot;GapSize&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_n_field</span> <span class="o">=</span> <span class="s2">&quot;Epochs_n&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n_field</span> <span class="o">=</span> <span class="s2">&quot;SmallGaps_n&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_id_field</span> <span class="o">=</span> <span class="s2">&quot;Epoch_Id&quot;</span>

        <span class="c1"># file fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_data_dtfield_field</span> <span class="o">=</span> <span class="s2">&quot;File_Data_DtField&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_data_varfield_field</span> <span class="o">=</span> <span class="s2">&quot;File_Data_VarField&quot;</span></div>


        <span class="c1"># ... continues in downstream objects ... #</span>

<div class="viewcode-block" id="TimeSeries._set_frequency">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries._set_frequency">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Guess the datetime resolution of a time series based on the consistency of</span>
<span class="sd">        timestamp components (e.g., seconds, minutes).</span>

<span class="sd">        .. caution::</span>

<span class="sd">            This method infers the datetime frequency of the time series data</span>
<span class="sd">            based on the consistency of timestamp components.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle void data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Copy the data</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Extract components of the datetime</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;minute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;second&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">second</span>

            <span class="c1"># Check consistency within each unit of time</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;second&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span> <span class="o">=</span> <span class="s2">&quot;1min&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtres</span> <span class="o">=</span> <span class="s2">&quot;second&quot;</span>
            <span class="k">elif</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;minute&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span> <span class="o">=</span> <span class="s2">&quot;20min&quot;</span>  <span class="c1"># force to 20min</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtres</span> <span class="o">=</span> <span class="s2">&quot;minute&quot;</span>
            <span class="k">elif</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span> <span class="o">=</span> <span class="s2">&quot;h&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtres</span> <span class="o">=</span> <span class="s2">&quot;hour&quot;</span>
            <span class="k">elif</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtres</span> <span class="o">=</span> <span class="s2">&quot;day&quot;</span>
            <span class="k">elif</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtres</span> <span class="o">=</span> <span class="s2">&quot;month&quot;</span>
                <span class="c1"># force gapsize to 1 when daily+ time scale</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gapsize</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span> <span class="o">=</span> <span class="s2">&quot;YS&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtres</span> <span class="o">=</span> <span class="s2">&quot;year&quot;</span>
                <span class="c1"># force gapsize to 1 when daily+ time scale</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gapsize</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># Get methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="TimeSeries.get_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.get_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a dictionary with object metadata.</span>
<span class="sd">        Expected to increment superior methods.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Metadata does **not** necessarily inclue all object attributes.</span>

<span class="sd">        :return: dictionary with all metadata</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ------------ call super ----------- #</span>
        <span class="n">dict_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>

        <span class="c1"># customize local metadata:</span>
        <span class="n">dict_meta_local</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># TS info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="c1"># Variable info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">varfield_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">varname_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">varalias_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datarange_min_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datarange_min</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datarange_max_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datarange_max</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_min_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_min</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_max_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_max</span><span class="p">,</span>
            <span class="c1"># DateTime info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtfield_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtres_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtres</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
            <span class="c1"># Standardization</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isstandard_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_standard</span><span class="p">,</span>
            <span class="c1"># Epochs info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gapsize_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gapsize</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epochs_n_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_n</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n</span><span class="p">,</span>
            <span class="c1"># file data info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_data_dtfield_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_data_dtfield</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_data_varfield_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_data_varfield</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># update</span>
        <span class="n">dict_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dict_meta_local</span><span class="p">)</span>
        <span class="c1"># mode file_data to the end</span>
        <span class="n">dict_meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_file_data</span><span class="p">)</span>
        <span class="n">dict_meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_file_data</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_data</span>
        <span class="k">return</span> <span class="n">dict_meta</span></div>


    <span class="c1"># Core methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="TimeSeries.update">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update internal attributes based on the current data.</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - Calls the ``set_frequency`` method to update the datetime frequency attribute.</span>
<span class="sd">        - Updates the ``start`` attribute with the minimum datetime value in the data.</span>
<span class="sd">        - Updates the ``end`` attribute with the maximum datetime value in the data.</span>
<span class="sd">        - Updates the ``var_min`` attribute with the minimum value of the variable field in the data.</span>
<span class="sd">        - Updates the ``var_max`` attribute with the maximum value of the variable field in the data.</span>
<span class="sd">        - Updates the ``data_size`` attribute with the length of the data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_frequency</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;xmax_aux&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="c1"># ... continues in downstream objects ... #</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TimeSeries.setter">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.setter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_setter</span><span class="p">,</span> <span class="n">load_data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set selected attributes based on an incoming dictionary.</span>
<span class="sd">        Expected to increment superior methods.</span>

<span class="sd">        :param dict_setter: incoming dictionary with attribute values</span>
<span class="sd">        :type dict_setter: dict</span>
<span class="sd">        :param load_data: option for loading data from incoming file. Default is True.</span>
<span class="sd">        :type load_data: bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ---------- call super --------- #</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setter</span><span class="p">(</span><span class="n">dict_setter</span><span class="o">=</span><span class="n">dict_setter</span><span class="p">,</span> <span class="n">load_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># ---------- set basic attributes --------- #</span>

        <span class="c1"># -------------- set data logic here -------------- #</span>
        <span class="k">if</span> <span class="n">load_data</span><span class="p">:</span>
            <span class="c1"># handle missing keys</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_setter</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">input_dtfield</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># assume default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">input_dtfield</span> <span class="o">=</span> <span class="n">dict_setter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield_field</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_setter</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">input_varfield</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># assume default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">input_varfield</span> <span class="o">=</span> <span class="n">dict_setter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield_field</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;Sep&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_setter</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">in_sep</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span>  <span class="c1"># assume default</span>
            <span class="c1"># call load</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                <span class="n">file_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_data</span><span class="p">,</span>
                <span class="n">input_dtfield</span><span class="o">=</span><span class="n">input_dtfield</span><span class="p">,</span>
                <span class="n">input_varfield</span><span class="o">=</span><span class="n">input_varfield</span><span class="p">,</span>
                <span class="n">in_sep</span><span class="o">=</span><span class="n">in_sep</span><span class="p">,</span>
            <span class="p">)</span></div>


        <span class="c1"># ... continues in downstream objects ... #</span>

    <span class="c1"># Data methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="TimeSeries.set_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.set_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_df</span><span class="p">,</span> <span class="n">input_dtfield</span><span class="p">,</span> <span class="n">input_varfield</span><span class="p">,</span> <span class="n">filter_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dropnan</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set time series data from an inputs DataFrame.</span>

<span class="sd">        :param input_df: Input DataFrame containing time series data.</span>
<span class="sd">        :type input_df: :class:`pandas.DataFrame`</span>
<span class="sd">        :param input_dtfield: Name of the datetime field in the inputs DataFrame.</span>
<span class="sd">        :type input_dtfield: str</span>
<span class="sd">        :param input_varfield: Name of the variable field in the inputs DataFrame.</span>
<span class="sd">        :type input_varfield: str</span>
<span class="sd">        :param filter_dates: List of [Start, End] used for filtering date range.</span>
<span class="sd">        :type dropnan: list</span>
<span class="sd">        :param dropnan: If True, drop NaN values from the DataFrame. Default is True.</span>
<span class="sd">        :type dropnan: bool</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - Assumes the inputs DataFrame has a datetime column in the format &quot;YYYY-mm-DD HH:MM:SS&quot;.</span>
<span class="sd">        - Renames columns to standard format (datetime: ``self.dtfield``, variable: ``self.varfield``).</span>
<span class="sd">        - Converts the datetime column to standard format.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get a copy of the inputs DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Rename columns to standard format</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">input_dtfield</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">input_varfield</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Filter data only to columns</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Drop NaN values if specified</span>
        <span class="k">if</span> <span class="n">dropnan</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># Convert datetime column to standard format</span>
        <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m0-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_dates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &gt;= &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">filter_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">filter_dates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &lt; &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">filter_dates</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Set the data attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># update all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TimeSeries.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_data</span><span class="p">,</span>
        <span class="n">input_dtfield</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">input_varfield</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">in_sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span>
        <span class="n">filter_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data from file. Expected to overwrite superior methods.</span>

<span class="sd">        :param file_data: Absolute Path to the ``csv`` inputs file.</span>
<span class="sd">        :type file_data: str</span>
<span class="sd">        :param input_varfield: Name of the incoming varfield.</span>
<span class="sd">        :type input_varfield: str</span>
<span class="sd">        :param input_dtfield: Name of the incoming datetime field. Default is &quot;datetime&quot;.</span>
<span class="sd">        :type input_dtfield: str</span>
<span class="sd">        :param sep: String separator. Default is ``;``.</span>
<span class="sd">        :type sep: str</span>
<span class="sd">        :param filter_dates: List of start and end date to filter. Default is None</span>
<span class="sd">        :type sep: list</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - Assumes the inputs file is in ``csv`` format.</span>
<span class="sd">        - Expects a datetime column in the format ``YYYY-mm-DD HH:MM:SS``.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># -------------- overwrite relative path inputs -------------- #</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>

        <span class="c1"># -------------- implement loading logic -------------- #</span>

        <span class="c1"># assume defaults</span>
        <span class="k">if</span> <span class="n">input_dtfield</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_dtfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_data_dtfield</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_data_dtfield</span> <span class="o">=</span> <span class="n">input_dtfield</span>

        <span class="k">if</span> <span class="n">input_varfield</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_varfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_data_varfield</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_data_varfield</span> <span class="o">=</span> <span class="n">input_varfield</span>

        <span class="c1"># -------------- call loading function -------------- #</span>
        <span class="c1"># print(self.file_data_dtfield)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">file_data</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="n">in_sep</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="n">input_varfield</span><span class="p">:</span> <span class="nb">float</span><span class="p">},</span>
            <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="n">input_dtfield</span><span class="p">,</span> <span class="n">input_varfield</span><span class="p">],</span>
            <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_data_dtfield</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># print(df[self.file_data_dtfield].dtype)</span>

        <span class="c1"># -------------- post-loading logic -------------- #</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">input_dtfield</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">input_varfield</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_dates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &gt;= &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">filter_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">filter_dates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &lt; &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">filter_dates</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Set the data attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># ------------ update related attributes ------------ #</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_data</span> <span class="o">=</span> <span class="n">file_data</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TimeSeries.cut_edges">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.cut_edges">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cut_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cut off initial and final NaN records in a given time series.</span>

<span class="sd">        :param inplace: If True, the operation will be performed in-place, and the original data will be modified.</span>
<span class="sd">            If False, a new DataFrame with cut edges will be returned, and the original data will remain unchanged.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        :type inplace: bool</span>
<span class="sd">        :return: If inplace is False, a new DataFrame with cut edges.</span>
<span class="sd">            If inplace is True, returns None, and the original data is modified in-place.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame``` or None</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - This function removes leading and trailing rows with NaN values in the specified variable field.</span>
<span class="sd">        - The operation is performed on a copy of the original data, and the original data remains unchanged.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get dataframe</span>
        <span class="n">in_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">def_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_df</span><span class="p">)</span>

        <span class="c1"># drop first nan lines</span>
        <span class="n">drop_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># loop to collect indexes in the start of series</span>
        <span class="k">for</span> <span class="n">def_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">def_len</span><span class="p">):</span>  <span class="c1"># go forward</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="n">in_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">def_i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">aux</span><span class="p">:</span>
                <span class="n">drop_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">def_i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># loop to collect indexes in the end of series</span>
        <span class="k">for</span> <span class="n">def_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">def_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># go backward</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="n">in_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">def_i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">aux</span><span class="p">:</span>
                <span class="n">drop_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">def_i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># loop to drop rows:</span>
        <span class="k">for</span> <span class="n">def_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drop_ids</span><span class="p">)):</span>
            <span class="n">in_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_ids</span><span class="p">[</span><span class="n">def_i</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># output</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">in_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">in_df</span></div>


<div class="viewcode-block" id="TimeSeries.standardize">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.standardize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">standardize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Standardize the data based on regular datetime steps and the time resolution.</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - Creates a full date range with the expected frequency for the standardization period.</span>
<span class="sd">        - Groups the data by epochs (based on the frequency and datetime field), applies the specified aggregation function, and fills in missing values with left merges.</span>
<span class="sd">        - Updates internal attributes, including ``self.isstandard`` to indicate that the data has been standardized.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The ``standardize`` method modifies the internal data representation.</span>
<span class="sd">            Ensure to review the data after standardization.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_insert_epochs</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="c1"># handle epochs</span>
            <span class="n">epochs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;1min&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;%Y-%m0-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
                <span class="s2">&quot;20min&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;%Y-%m0-</span><span class="si">%d</span><span class="s2"> %H&quot;</span><span class="p">,</span> <span class="s2">&quot; :20&quot;</span><span class="p">],</span>
                <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;%Y-%m0-</span><span class="si">%d</span><span class="s2"> %H&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
                <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;%Y-%m0-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
                <span class="s2">&quot;MS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;%Y-%m0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
                <span class="s2">&quot;YS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span> <span class="o">+</span> <span class="s2">&quot;_epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">epochs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">epochs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="c1"># the ideia is to implement regular time increments and insert null rows</span>

        <span class="c1"># make a copy of the data</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># insert epochs based on data frequency</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="n">_insert_epochs</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_data</span><span class="p">)</span>
        <span class="c1"># aggregate by epoch</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span> <span class="o">+</span> <span class="s2">&quot;_epoch&quot;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="p">])</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">df_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Standardize incoming start and end</span>
        <span class="n">start_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>  <span class="c1"># the start of day</span>
        <span class="n">end_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># the start of next day</span>
        <span class="n">end_std</span> <span class="o">=</span> <span class="n">end_std</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="c1"># Get a standard date range for all periods</span>
        <span class="n">dt_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_std</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_std</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfreq</span><span class="p">)</span>

        <span class="c1"># Set standarnd dataframe</span>
        <span class="n">df_data_std</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">:</span> <span class="n">dt_index</span><span class="p">})</span>
        <span class="n">df_data_std</span> <span class="o">=</span> <span class="n">_insert_epochs</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_data_std</span><span class="p">)</span>

        <span class="n">on_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span> <span class="o">+</span> <span class="s2">&quot;_epoch&quot;</span>
        <span class="n">df_data_std</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">df_data_std</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">df_data</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">on_st</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Clear extra column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">df_data_std</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">on_st</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># [removed] Cut off edges</span>
        <span class="c1"># self.cut_edges(inplace=True)</span>

        <span class="c1"># Set extra attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_standard</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Update all attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TimeSeries.clear_outliers">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.clear_outliers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears outlier values from the specified variable field in the DataFrame.</span>

<span class="sd">        :param inplace: If True, the operation is performed in-place, modifying the DataFrame directly. If False, a new DataFrame with outliers removed is returned. Default value = False</span>
<span class="sd">        :type inplace: if `inplace` is True, otherwise the DataFrame with outliers cleared.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame` or None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># copy local data</span>
        <span class="n">vct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Clear lower values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datarange_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vct</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">datarange_min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">vct</span><span class="p">)</span>

        <span class="c1"># Clear upper values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datarange_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vct</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">datarange_max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">vct</span><span class="p">)</span>

        <span class="c1"># return case</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="c1"># overwrite local data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">vct</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeries.get_epochs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.get_epochs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_epochs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Epochs (periods) for continuous time series (0 = gap epoch).</span>

<span class="sd">        :param inplace: Option to set Epochs inplace. Default is False.</span>
<span class="sd">        :type inplace: bool</span>
<span class="sd">        :return: A DataFrame if inplace is False or None.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame``, None</span>

<span class="sd">        **Notes**</span>

<span class="sd">        This function labels continuous chunks of data as Epochs, with Epoch 0</span>
<span class="sd">        representing gaps in the time series.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Create a helper column to label continuous chunks of data</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CumSum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span>
            <span class="o">.</span><span class="n">isna</span><span class="p">()</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span>
            <span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># get skip hint</span>
        <span class="c1"># print(f&quot;debug: {self.gapsize}&quot;)</span>
        <span class="n">skip_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">n_curr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CumSum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">n_next</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CumSum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n_next</span> <span class="o">&lt;</span> <span class="n">n_curr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_curr</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gapsize</span><span class="p">:</span>
                    <span class="n">n_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">n_curr</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n_curr</span><span class="p">:</span>
                        <span class="n">n_start</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">skip_v</span><span class="p">[</span><span class="n">n_start</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Skip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skip_v</span>

        <span class="c1"># Set Epoch Field</span>
        <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_id_field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># counter epochs</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Skip&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_id_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Skip&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Skip&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_id_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CumSum&quot;</span><span class="p">,</span> <span class="s2">&quot;Skip&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeries.update_epochs_stats">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.update_epochs_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_epochs_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update all epochs statistics.</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - This function updates statistics for all epochs in the time series.</span>
<span class="sd">        - Ensures that the data is standardized by calling the ``standardize`` method if it&#39;s not already standardized.</span>
<span class="sd">        - Removes epoch 0 from the statistics since it typically represents non-standardized or invalid data.</span>
<span class="sd">        - Groups the data by ``Epoch_Id`` and calculates statistics such as count, start, and end timestamps for each epoch.</span>
<span class="sd">        - Generates random colors for each epoch using the ``get_random_colors`` function with a specified colormap (`cmap`` attribute).</span>
<span class="sd">        - Includes the time series name in the statistics for identification.</span>
<span class="sd">        - Organizes the statistics DataFrame to include relevant columns: ``Name``, ``Epoch_Id``, ``Count``, ``Start``, ``End``, and ``Color``.</span>
<span class="sd">        - Updates the attribute ``epochs_n`` with the number of epochs in the statistics.</span>

<span class="sd">        **Examples**</span>

<span class="sd">        todo [examples]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Ensure data is standardized</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_standard</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">()</span>

        <span class="c1"># Get epochs</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_epochs</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Remove epoch = 0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_id_field</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n_field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># group by</span>
        <span class="n">aggregation_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epochs_n_field</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_id_field</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_field</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_field</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n_field</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n_field</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_id_field</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="o">**</span><span class="n">aggregation_dict</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Get colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_color</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_colors</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span>
        <span class="p">)</span>

        <span class="c1"># Include name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Organize fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epochs_id_field</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epochs_n_field</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n_field</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_field</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_field</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_color</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># Update attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smallgaps_n_field</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TimeSeries.interpolate_gaps">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.interpolate_gaps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">interpolate_gaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills gaps in a time series using various interpolation methods.</span>

<span class="sd">        :param method: Specifies the interpolation method. The default value is ``linear``.</span>
<span class="sd">        :type method: str</span>
<span class="sd">        :param constant: The constant value used when the ``constant`` method is selected. Default value = 0.</span>
<span class="sd">        :type constant: float</span>
<span class="sd">        :param inplace: If True, modifies the original DataFrame in-place. Default value = False.</span>
<span class="sd">        :type inplace: bool</span>
<span class="sd">        :return: A new ``pandas.DataFrame`` with interpolated values if inplace is False, otherwise None.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame` or None</span>

<span class="sd">        **Notes**</span>

<span class="sd">        This function handles time series data, standardizing it if necessary before performing interpolation.</span>
<span class="sd">        The process is applied to each unique epoch within the series.</span>

<span class="sd">         - ``linear``: linear interpolation</span>
<span class="sd">         - ``nearest``: uses the value of the closest data point.</span>
<span class="sd">         - ``zero``: fills gaps with zeros.</span>
<span class="sd">         - ``constant``: fills gaps with a constant value provided in method parameter</span>
<span class="sd">         - ``slinear``: first order spline interpolation</span>
<span class="sd">         - ``quadratic``: second order spline interpolation</span>
<span class="sd">         - ``cubic``: third order spline interpolation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>

        <span class="c1"># Ensure data is standardized</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_standard</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">()</span>

        <span class="c1"># Get epochs for interpolation</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_epochs</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Epoch_Id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">list_dfs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
            <span class="n">df_aux1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Epoch_Id == </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df_aux1</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_interp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;constant&quot;</span><span class="p">:</span>
                    <span class="n">df_aux1</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_interp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">df_aux1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span>
                        <span class="n">constant</span><span class="p">,</span>
                        <span class="n">df_aux1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># use scipy methods</span>
                    <span class="c1"># clear from nan values</span>
                    <span class="n">df_aux2</span> <span class="o">=</span> <span class="n">df_aux1</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1"># Create an interpolation function</span>
                    <span class="n">interpolation_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                        <span class="n">df_aux2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">df_aux2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                        <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Interpolate full values</span>
                    <span class="n">df_aux1</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_interp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">)]</span> <span class="o">=</span> <span class="n">interpolation_func</span><span class="p">(</span>
                        <span class="n">df_aux1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="c1"># Append</span>
            <span class="n">list_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_aux1</span><span class="p">)</span>
        <span class="n">df_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">list_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_new</span> <span class="o">=</span> <span class="n">df_new</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_interp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df_new</span></div>


<div class="viewcode-block" id="TimeSeries.aggregate">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.aggregate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">bad_max</span><span class="p">,</span> <span class="n">agg_funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregate the time series data based on a specified frequency using various aggregation functions.</span>

<span class="sd">        :param freq: Pandas-like alias frequency at which to aggregate the time series data.</span>
<span class="sd">        :type freq: str</span>
<span class="sd">        :param bad_max: The maximum number of ``Bad`` records allowed in a time window for aggregation. Records with more ``Bad`` entries will be excluded from the aggregated result. Default is 7.</span>
<span class="sd">        :type bad_max: int</span>
<span class="sd">        :param agg_funcs: A dictionary specifying customized aggregation functions for each variable. Default is None,</span>
<span class="sd">            which uses standard aggregation functions (sum, mean, median, min, max, std, var, percentiles).</span>
<span class="sd">        :type agg_funcs: dict</span>
<span class="sd">        :return: A new `pandas.DataFrame` with aggregated values based on the specified frequency.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>

<span class="sd">        **Notes**</span>

<span class="sd">        Resamples the time series data to the specified frequency using Pandas-like alias strings.</span>
<span class="sd">        Aggregates the values using the specified aggregation functions.</span>
<span class="sd">        Counts the number of ``Bad`` records in each time window and excludes time windows with more ``Bad`` entries</span>
<span class="sd">        than the specified threshold.</span>

<span class="sd">        Common options include:</span>
<span class="sd">         - ``h`` for hourly frequency</span>
<span class="sd">         - ``D`` for daily frequency</span>
<span class="sd">         - ``W`` for weekly frequency</span>
<span class="sd">         - ``MS`` for monthly/start frequency</span>
<span class="sd">         - ``QS`` for quarterly/start frequency</span>
<span class="sd">         - ``YS`` for yearly/start frequency</span>

<span class="sd">        More options and details can be found in the Pandas documentation:</span>
<span class="sd">        https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#timeseries-offset-aliases.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">agg_funcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create a dictionary of standard and custom aggregation functions</span>
            <span class="n">agg_funcs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;sum&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
                <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span>
                <span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="s2">&quot;var&quot;</span><span class="p">,</span>
            <span class="p">}</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            # Add custom percentiles to the dictionary</span>
<span class="sd">            percentiles_to_compute = [1, 5, 10, 25, 50, 75, 90, 95, 99]</span>
<span class="sd">            for p in percentiles_to_compute:</span>
<span class="sd">                agg_funcs[f&quot;p{p}&quot;] = lambda x, p=p: np.percentile(x, p)</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="c1"># set list of tuples</span>
        <span class="n">agg_funcs_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">agg_funcs</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">agg_funcs</span>
        <span class="p">]</span>

        <span class="c1"># get data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Bad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># Set the &#39;datetime&#39; column as the index</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Redata the time series to a frequency using aggregation functions</span>
        <span class="n">agg_df1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">freq</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_funcs_list</span><span class="p">)</span>
        <span class="n">agg_df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">freq</span><span class="p">)[</span><span class="s2">&quot;Bad&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([(</span><span class="s2">&quot;Bad_count&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">)])</span>

        <span class="c1"># Reset the index to get &#39;datetime&#39; as a regular column</span>
        <span class="n">agg_df1</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">agg_df2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># merge with bad dates</span>
        <span class="n">agg_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">agg_df1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">agg_df2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">)</span>

        <span class="c1"># set new df</span>
        <span class="n">agg_df_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">agg_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">end</span><span class="o">=</span><span class="n">agg_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># remove bad records</span>
        <span class="n">agg_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">agg_df</span><span class="p">[</span><span class="n">agg_df</span><span class="p">[</span><span class="s2">&quot;Bad_count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bad_max</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># remove bad column</span>
        <span class="n">agg_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Bad_count&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># left join</span>
        <span class="n">agg_df_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="n">agg_df_new</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">agg_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">agg_df_new</span></div>


<div class="viewcode-block" id="TimeSeries.upscale">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.upscale">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">bad_max</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upscale time series for larger time steps. This method uses the `agg` attribute.</span>
<span class="sd">        See the `aggregate` method.</span>

<span class="sd">        :param freq: Pandas-like alias frequency at which to aggregate the time series data.</span>
<span class="sd">            Common options include:</span>
<span class="sd">            - ``h`` for hourly frequency</span>
<span class="sd">            - ``D`` for daily frequency</span>
<span class="sd">            - ``W`` for weekly frequency</span>
<span class="sd">            - ``MS`` for monthly/start frequency</span>
<span class="sd">            - ``QS`` for quarterly/start frequency</span>
<span class="sd">            - ``YS`` for yearly/start frequency</span>
<span class="sd">            More options and details can be found in the Pandas documentation:</span>
<span class="sd">            https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#timeseries-offset-aliases.</span>
<span class="sd">        :type freq: str</span>
<span class="sd">        :param bad_max: The maximum number of ``Bad`` records allowed in a time window for aggregation. Records with more ``Bad`` entries</span>
<span class="sd">            will be excluded from the aggregated result.</span>
<span class="sd">        :type bad_max: int</span>
<span class="sd">        :param inplace: option for overwrite data, default True</span>
<span class="sd">        :type inplace: bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_upscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">bad_max</span><span class="o">=</span><span class="n">bad_max</span><span class="p">,</span> <span class="n">agg_funcs</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">df_upscale</span> <span class="o">=</span> <span class="n">df_upscale</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># return case</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="c1"># overwrite local data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">df_upscale</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_frequency</span><span class="p">()</span>

            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df_upscale</span></div>


    <span class="c1"># todo develop -- improve methods of downscaling</span>
<div class="viewcode-block" id="TimeSeries.downscale">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.downscale">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">downscale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Donwscale time series for smaller time steps using linear inteporlation.</span>

<span class="sd">        :param freq: new time step frequency</span>
<span class="sd">        :type freq: str</span>
<span class="sd">        :return: Dataframe of downscaled data</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="c1"># get new index</span>
        <span class="n">dt_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
        <span class="c1"># set new dataframe</span>
        <span class="n">df_downscale</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">:</span> <span class="n">dt_index</span><span class="p">})</span>
        <span class="n">df_downscale</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="n">df_downscale</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
        <span class="p">)</span>

        <span class="c1"># handle flow variable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>

            <span class="c1"># compute downscaling factor assuming at least 2 data points</span>
            <span class="n">tdelta_source</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">tdelta_new</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df_downscale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">df_downscale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">factor_downscale</span> <span class="o">=</span> <span class="n">tdelta_new</span> <span class="o">/</span> <span class="n">tdelta_source</span>
            <span class="c1"># apply factor</span>
            <span class="n">df_downscale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_downscale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor_downscale</span>

        <span class="c1"># interpolate voids using linear method</span>
        <span class="n">df_downscale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_downscale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
            <span class="c1"># apply factor for numerical loss/gain</span>
            <span class="n">up_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">down_sum</span> <span class="o">=</span> <span class="n">df_downscale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">diff_factor</span> <span class="o">=</span> <span class="n">down_sum</span> <span class="o">/</span> <span class="n">up_sum</span>
            <span class="n">df_downscale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_downscale</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span> <span class="o">/</span> <span class="n">diff_factor</span>

        <span class="k">return</span> <span class="n">df_downscale</span></div>


<div class="viewcode-block" id="TimeSeries.assess_extreme_values">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.assess_extreme_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assess_extreme_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eva_freq</span><span class="o">=</span><span class="s2">&quot;YS&quot;</span><span class="p">,</span> <span class="n">eva_agg</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run Extreme Values Analysis (EVA) over the Time Series and set the ``eva`` attribute</span>

<span class="sd">        :param eva_freq: standard pandas frequency alias for upscaling data</span>
<span class="sd">        :type eva_freq: str</span>
<span class="sd">        :param eva_agg: standard pandas aggregation alias for upscaling (expected: ``max`` or ``min``)</span>
<span class="sd">        :type eva_agg: str</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># set agg to max</span>
        <span class="n">agg_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agg</span> <span class="o">=</span> <span class="n">eva_agg</span>

        <span class="c1"># upscale time series</span>
        <span class="n">df_eva</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upscale</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">eva_freq</span><span class="p">,</span> <span class="n">bad_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gapsize</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df_eva</span> <span class="o">=</span> <span class="n">df_eva</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># reset agg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agg</span> <span class="o">=</span> <span class="n">agg_old</span>

        <span class="c1"># fix dates to match actual maxima by making YEAR-Value tag</span>
        <span class="n">df_eva</span><span class="p">[</span><span class="s2">&quot;tag1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_eva</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; - &quot;</span>
            <span class="o">+</span> <span class="n">df_eva</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_d</span><span class="p">[</span><span class="s2">&quot;tag2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; - &quot;</span>
            <span class="o">+</span> <span class="n">df_d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># join by tag</span>
        <span class="n">df_eva</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">df_eva</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;tag1&quot;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">df_d</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;tag2&quot;</span><span class="p">)</span>
        <span class="n">df_eva</span> <span class="o">=</span> <span class="n">df_eva</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;tag1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># remake max df</span>
        <span class="n">df_eva</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">:</span> <span class="n">df_eva</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="si">}</span><span class="s2">_y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">:</span> <span class="n">df_eva</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="si">}</span><span class="s2">_y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Setup Univar Object for Maxima Assessment</span>
        <span class="n">uv_eva</span> <span class="o">=</span> <span class="n">Univar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;EVA </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;EVA_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">varalias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">uv_eva</span><span class="o">.</span><span class="n">varfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span>
        <span class="n">uv_eva</span><span class="o">.</span><span class="n">varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varname</span>
        <span class="n">uv_eva</span><span class="o">.</span><span class="n">varalias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span>
        <span class="n">uv_eva</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">df_eva</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">uv_eva</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># run Gumbel assessment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eva</span> <span class="o">=</span> <span class="n">uv_eva</span><span class="o">.</span><span class="n">assess_gumbel_cdf</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># View internal methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="TimeSeries._build_axes">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries._build_axes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="c1"># ------------ setup axes ------------</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">21</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">23</span><span class="p">:</span><span class="mi">28</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">29</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hey&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">31</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">21</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">23</span><span class="p">:</span><span class="mi">28</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">29</span><span class="p">:])</span>

        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="TimeSeries._get_fig_specs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries._get_fig_specs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_fig_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="c1"># handle specs</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># handle mode</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="n">specs_aux</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span>
                <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">FIG_SIZES</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">][</span><span class="s2">&quot;w&quot;</span><span class="p">],</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">FIG_SIZES</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">][</span><span class="s2">&quot;h&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">specs_aux</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span>
                <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">FIG_SIZES</span><span class="p">[</span><span class="s2">&quot;L2&quot;</span><span class="p">][</span><span class="s2">&quot;w&quot;</span><span class="p">],</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">FIG_SIZES</span><span class="p">[</span><span class="s2">&quot;L2&quot;</span><span class="p">][</span><span class="s2">&quot;h&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="c1"># update sizes</span>
        <span class="n">specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">specs_aux</span><span class="p">)</span>

        <span class="c1"># update gridspecs</span>
        <span class="n">specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">GRID_SPECS</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">specs</span></div>


<div class="viewcode-block" id="TimeSeries._plot">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries._plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
        <span class="c1"># handle mode</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="o">=</span><span class="n">gs</span><span class="p">,</span> <span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="o">=</span><span class="n">gs</span><span class="p">,</span> <span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="TimeSeries._set_view_specs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries._set_view_specs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_view_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set view specifications.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Call the parent method to initialize `view_specs`</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span>

        <span class="c1"># Update or add new specifications specific to the child class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;folder&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_src</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series | </span><span class="si">{}</span><span class="s2"> | </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span>
                <span class="p">),</span>
                <span class="s2">&quot;xvar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span>
                <span class="s2">&quot;yvar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">,</span>
                <span class="s2">&quot;xlabel&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawcolor</span><span class="p">,</span>
                <span class="s2">&quot;color_aux&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawcolor</span><span class="p">,</span>
                <span class="s2">&quot;color_fill&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawcolor</span><span class="p">,</span>
                <span class="s2">&quot;color_eva&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="s2">&quot;legend_eva&quot;</span><span class="p">:</span> <span class="s2">&quot;Annual Maxima&quot;</span><span class="p">,</span>
                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;alpha_aux&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;alpha_fill&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;fill&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;xmax_aux&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="s2">&quot;ymin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;ymax&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;linestyle&quot;</span><span class="p">:</span> <span class="s2">&quot;solid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;marker_eva&quot;</span><span class="p">:</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n_bins&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;subtitle_a&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;n_dates&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s2">&quot;include_eva&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;x_stats&quot;</span><span class="p">:</span> <span class="mf">0.73</span><span class="p">,</span>
                <span class="s2">&quot;x_stats_sep&quot;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span>
                <span class="s2">&quot;y_stats&quot;</span><span class="p">:</span> <span class="mf">0.28</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># View methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="TimeSeries.view">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.view">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        View the TimeSeries data.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Use values in the ``view_specs()`` attribute for plotting</span>

<span class="sd">        :param show: option for showing instead of saving.</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param return_fig: option for returning the figure object itself.</span>
<span class="sd">        :type return_fig: bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># handle eva specs</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;include_eva&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;hist_density&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;xlabel_b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;p(X)&quot;</span>

        <span class="c1"># handle mode specs</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;ax_histh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;ax_cdf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;ax_histh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;ax_cdf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># call base method and return the fig</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># -------------- PLOT EXTRA --------------</span>

        <span class="c1"># plotting series</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># todo develop DRY -- develop plotting static methods</span>
        <span class="c1"># --- call _plot()</span>

        <span class="c1"># series plot</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ax_data&quot;</span><span class="p">])</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ax_data&quot;</span><span class="p">]]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="c1"># plot series</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xvar&quot;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;yvar&quot;</span><span class="p">]],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># fill option</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;fill&quot;</span><span class="p">]:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;yvar&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">]</span>
            <span class="c1"># Fill below the time series</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xvar&quot;</span><span class="p">]],</span>
                <span class="n">y1</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span>
                <span class="n">y2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;yvar&quot;</span><span class="p">]],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;color_fill&quot;</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;alpha_fill&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="c1"># handle dates</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;n_dates&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_dates</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;n_dates&quot;</span><span class="p">]</span>
            <span class="n">dt_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">dt_col</span><span class="p">]</span>

            <span class="c1"># Handle n_dates dynamically</span>
            <span class="k">if</span> <span class="n">n_dates</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Just the first one</span>
                <span class="n">tick_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">n_dates</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># First and last</span>
                <span class="n">tick_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Evenly spaced positions across the dataset</span>
                <span class="n">tick_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dates</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="c1"># Get the corresponding dates</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tick_indices</span><span class="p">]</span>

            <span class="c1"># Apply to plot</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
        <span class="c1"># handle subtitle</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_a&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_a&quot;</span><span class="p">])</span>
        <span class="c1"># handle range</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">])</span>

        <span class="c1"># handle range x</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;range_x&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;range_x&quot;</span><span class="p">])</span>

        <span class="c1"># basic decorations</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xlabel&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ylabel&quot;</span><span class="p">])</span>

        <span class="c1"># handle eva</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;include_eva&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eva</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># ---- plot EVA series</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">],</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;color_eva&quot;</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;legend_eva&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

                <span class="c1"># ---- plot EVA histogram</span>
                <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span>
                    <span class="n">bins</span><span class="o">=</span><span class="n">Univar</span><span class="o">.</span><span class="n">nbins_fd</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;color_eva&quot;</span><span class="p">],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
                    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;legend_eva&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="c1"># ax2.legend()</span>

                <span class="c1"># ---- plot EVA model</span>
                <span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">][</span><span class="s2">&quot;T(X)_Weibull&quot;</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">],</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>  <span class="c1"># specs[&quot;color_eva&quot;],</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Empirical&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data_T(X)&quot;</span><span class="p">][</span><span class="s2">&quot;T(X)_Gumbel&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data_T(X)&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gumbel&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data_T(X)&quot;</span><span class="p">][</span><span class="s2">&quot;T(X)_Gumbel&quot;</span><span class="p">],</span>
                    <span class="n">y1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data_T(X)&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="si">}</span><span class="s2">_P05&quot;</span><span class="p">],</span>
                    <span class="n">y2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eva</span><span class="p">[</span><span class="s2">&quot;Data_T(X)&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="si">}</span><span class="s2">_P95&quot;</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;90%CR&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                    <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span>
                <span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;T(X)&quot;</span><span class="p">)</span>

        <span class="c1"># -------------- SHIP --------------</span>
        <span class="c1"># create path</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;fig_format&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">viewer</span><span class="o">.</span><span class="n">ship_fig</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">file_output</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TimeSeries.view_epochs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.view_epochs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view_epochs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a basic visualization.</span>
<span class="sd">        Expected to overwrite superior methods.</span>

<span class="sd">        :param show: option for showing instead of saving.</span>
<span class="sd">        :type show: bool</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - Uses values in the ``view_specs()`` attribute for plotting</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get specs</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># --------------------- pre-processing --------------------- #</span>
        <span class="c1"># preprocessing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_epochs_stats</span><span class="p">()</span>

        <span class="c1"># --------------------- figure setup --------------------- #</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]))</span>  <span class="c1"># Width, Height</span>

        <span class="c1"># handle min max</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xvar&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;yvar&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xvar&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;yvar&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># --------------------- plotting --------------------- #</span>
        <span class="n">gaps_c</span> <span class="o">=</span> <span class="s2">&quot;tab:red&quot;</span>
        <span class="n">gaps_a</span> <span class="o">=</span> <span class="mf">0.6</span>
        <span class="c1"># plot loop</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">)):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">[</span><span class="s2">&quot;Start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">[</span><span class="s2">&quot;End&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">df_aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &gt;= &#39;</span><span class="si">{}</span><span class="s2">&#39; and </span><span class="si">{}</span><span class="s2"> &lt; &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">end</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">epoch_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">epoch_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_stats</span><span class="p">[</span><span class="s2">&quot;Epoch_Id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">df_aux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">],</span>
                <span class="n">df_aux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">],</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="n">epoch_c</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Epoch_</span><span class="si">{</span><span class="n">epoch_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Fill the space where there are missing values</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">df_aux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">],</span>
                <span class="n">y1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">y2</span><span class="o">=</span><span class="mf">1.2</span> <span class="o">*</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">],</span>
                <span class="n">where</span><span class="o">=</span><span class="n">df_aux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span>
                <span class="n">color</span><span class="o">=</span><span class="n">gaps_c</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">gaps_a</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Create a dummy plot for missing data symbol</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="n">gaps_c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">gaps_a</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gaps&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_n</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># --------------------- post-plotting --------------------- #</span>
        <span class="c1"># set basic plotting stuff</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ylabel&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xlabel&quot;</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">],</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">])</span>

        <span class="c1"># Adjust layout to prevent cutoff</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># --------------------- end --------------------- #</span>
        <span class="c1"># show or save</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;fig_format&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">file_path</span></div>


<div class="viewcode-block" id="TimeSeries.add_hour">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeries.add_hour">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_hour</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">dt_field</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="c1"># todo docstring</span>
        <span class="n">df</span><span class="p">[</span><span class="n">dt_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dt_field</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>
</div>



<span class="c1"># Chronological classes - collections</span>
<span class="c1"># -----------------------------------------------------------------------</span>


<div class="viewcode-block" id="TimeSeriesCollection">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimeSeriesCollection</span><span class="p">(</span><span class="n">Collection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A collection of time series objects with associated metadata.</span>

<span class="sd">    The ``TimeSeriesCollection`` or simply ``TSC`` class extends the ``Collection`` class and</span>
<span class="sd">    is designed to handle time series data. It can be miscellaneous datasets.</span>

<span class="sd">    .. note::</span>

<span class="sd">        See ``TimeSeriesCluster`` for managing time series of the same variable</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Dunder methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="TimeSeriesCollection.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;myTSCollection&quot;</span><span class="p">,</span> <span class="n">base_object</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># If base_object is not provided, create a default TimeSeries object</span>
        <span class="k">if</span> <span class="n">base_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_object</span> <span class="o">=</span> <span class="n">TimeSeries</span>

        <span class="c1"># Call the constructor of the parent class (TimeSeries)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">base_object</span><span class="o">=</span><span class="n">base_object</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Set up date fields and special attributes in the catalog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Start&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m0-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;End&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;End&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m0-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Set auto attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isstandard</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datarange_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datarange_max</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_src</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Set specific attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_object</span> <span class="o">=</span> <span class="s2">&quot;Time Series Collection&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span> <span class="o">=</span> <span class="s2">&quot;datetime&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overfield</span> <span class="o">=</span> <span class="s2">&quot;Overlapping&quot;</span>

        <span class="c1"># load view specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Core internal methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

    <span class="c1"># Core methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="TimeSeriesCollection.update">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the time series collection.</span>

<span class="sd">        :param details: bool, optional</span>
<span class="sd">            If True, update additional details.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        :type details: bool</span>

<span class="sd">        **Examples**</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Call the update method of the parent class (Collection)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">)</span>
        <span class="c1"># Update start, end, min, and max attributes based on catalog information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;End&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Var_min&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Var_max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span></div>


    <span class="c1"># Data methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="TimeSeriesCollection.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_file</span><span class="p">,</span> <span class="n">filter_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data from table file (information table) into the time series collection.</span>

<span class="sd">        :param table_file: Path to file. Expected to be a ``csv`` table.</span>
<span class="sd">        :type table_file: str</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">table_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">input_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">table_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">df_info</span><span class="o">=</span><span class="n">input_df</span><span class="p">,</span> <span class="n">src_dir</span><span class="o">=</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">filter_dates</span><span class="o">=</span><span class="n">filter_dates</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TimeSeriesCollection.set_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.set_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_info</span><span class="p">,</span> <span class="n">src_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set data for the time series collection from a info class:`pandas.DataFrame`.</span>

<span class="sd">        :param df_info: This DataFrame is expected to have matching fields to the metadata keys.</span>
<span class="sd">        :type df_info: class:`pandas.DataFrame`</span>
<span class="sd">        :param src_dir: Path for inputs directory in the case for only file names in ``File`` column.</span>
<span class="sd">        :type src_dir: str</span>
<span class="sd">        :param filter_dates: List of Start and End dates for filter data</span>
<span class="sd">        :type filter_dates: str</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - The ``set_data`` method populates the time series collection with data based on the provided DataFrame.</span>
<span class="sd">        - It creates time series objects, loads data, and performs additional processing steps.</span>
<span class="sd">        - Adjust ``skip_process`` according to your data processing needs.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># handle mutable fields</span>
        <span class="n">str_varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseobject</span><span class="p">()</span><span class="o">.</span><span class="n">varname</span>
        <span class="n">list_mutables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Units&quot;</span><span class="p">,</span> <span class="s2">&quot;DtField&quot;</span><span class="p">,</span> <span class="s2">&quot;VarField&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">]</span>
        <span class="n">dict_m_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">list_mutables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">df_info</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># assume &lt;Varname&gt;_ prefix:</span>
                <span class="n">dict_m_fields</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dict_m_fields</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_varname</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_info</span><span class="p">)):</span>
            <span class="c1"># create object</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseobject</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">df_info</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">df_info</span><span class="p">[</span><span class="s2">&quot;Alias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">df_info</span><span class="p">[</span><span class="n">dict_m_fields</span><span class="p">[</span><span class="s2">&quot;Units&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># handle inputs file</span>
            <span class="n">input_file</span> <span class="o">=</span> <span class="n">df_info</span><span class="p">[</span><span class="n">dict_m_fields</span><span class="p">[</span><span class="s2">&quot;File&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># if is a path:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># assume file name only and concat</span>
                <span class="k">if</span> <span class="n">src_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">input_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">input_file</span><span class="p">)</span>
            <span class="c1"># load data</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                <span class="n">file_data</span><span class="o">=</span><span class="n">input_file</span><span class="p">,</span>
                <span class="n">input_varfield</span><span class="o">=</span><span class="n">df_info</span><span class="p">[</span><span class="n">dict_m_fields</span><span class="p">[</span><span class="s2">&quot;VarField&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">input_dtfield</span><span class="o">=</span><span class="n">df_info</span><span class="p">[</span><span class="n">dict_m_fields</span><span class="p">[</span><span class="s2">&quot;DtField&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">filter_dates</span><span class="o">=</span><span class="n">filter_dates</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># extra attrs</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">df_info</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">df_info</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">df_info</span><span class="p">[</span><span class="s2">&quot;Code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">df_info</span><span class="p">[</span><span class="s2">&quot;Source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">df_info</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">df_info</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># append</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_object</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TimeSeriesCollection.clear_outliers">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.clear_outliers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear outliers in the collection based on the ``datarange_min`` and ``datarange_max`` attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">datarange_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datarange_min</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">datarange_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datarange_max</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">clear_outliers</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TimeSeriesCollection.merge_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.merge_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge data from multiple sources into a single DataFrame.</span>

<span class="sd">        :return: A merged DataFrame with datetime and variable fields from different sources.</span>
<span class="sd">        :rtype: pandas.DataFrame</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - Updates the catalog details.</span>
<span class="sd">        - Merges data from different sources based on the specified datetime field and variable field.</span>
<span class="sd">        - The merged DataFrame includes a date range covering the entire period.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure catalog is updated with details</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get start, end, and frequency from the catalog</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>

        <span class="c1"># todo handle this issue on the first freq</span>
        <span class="c1"># consider the first freq</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;DtFreq&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Create a date range for the entire period</span>
        <span class="n">dt_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">:</span> <span class="n">dt_index</span><span class="p">})</span>

        <span class="c1"># Merging loop for each catalog entry</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="c1"># Get attributes from the catalog</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_alias</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">varfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;VarField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">dtfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;DtField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Handle datetime field and set up right DataFrame</span>
            <span class="n">b_drop</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span> <span class="o">==</span> <span class="n">dtfield</span><span class="p">:</span>
                <span class="n">suffs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">dt_right_after</span> <span class="o">=</span> <span class="n">dtfield</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">suffs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_right&quot;</span><span class="p">)</span>
                <span class="n">b_drop</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">df_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">varfield</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_right</span> <span class="o">=</span> <span class="n">df_right</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">varfield</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varfield</span><span class="p">,</span> <span class="n">alias</span><span class="p">)}</span>
            <span class="p">)</span>

            <span class="c1"># Left join the DataFrames</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">left</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">left_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span>
                <span class="n">right</span><span class="o">=</span><span class="n">df_right</span><span class="p">,</span>
                <span class="n">right_on</span><span class="o">=</span><span class="n">dtfield</span><span class="p">,</span>
                <span class="n">suffixes</span><span class="o">=</span><span class="n">suffs</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Clear the right datetime column if needed</span>
            <span class="k">if</span> <span class="n">b_drop</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">dt_right_after</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesCollection.standardize">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.standardize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">standardize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method standardizes all time series objects in the collection.</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - The method iterates through each time series in the collection and standardizes it.</span>
<span class="sd">        - After standardizing individual time series, the data is merged.</span>
<span class="sd">        - The merged data is then reset for each individual time series in the collection.</span>
<span class="sd">        - Epoch statistics are updated for each time series after the reset.</span>
<span class="sd">        - Finally, the collection catalog is updated with details.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Standardize and fill gaps across all series [overwrite]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">standardize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate_gaps</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Merge data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_data</span><span class="p">()</span>

        <span class="c1"># helper dict -- alias is the key</span>
        <span class="n">dict_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Alias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">dict_names</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Reset data for each time series</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="c1"># filter merged dataframe</span>
            <span class="n">df_aux</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="n">c</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">alias</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dict_names</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
            <span class="c1"># set data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
                <span class="n">input_df</span><span class="o">=</span><span class="n">df_aux</span><span class="p">,</span>
                <span class="n">input_dtfield</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span>
                <span class="n">input_varfield</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                <span class="n">dropnan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Update epochs statistics for each time series</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update_epochs_stats</span><span class="p">()</span>

        <span class="c1"># Update the collection catalog with details</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Set standard flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isstandard</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TimeSeriesCollection.merge_local_epochs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.merge_local_epochs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_local_epochs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge local epochs statistics from individual time series within the collection.</span>

<span class="sd">        :return: Merged :class:`pandas.DataFrame``` containing epochs statistics.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - This method creates an empty list to store individual epochs statistics dataframes.</span>
<span class="sd">        - It iterates through each time series in the collection.</span>
<span class="sd">        - For each time series, it updates the local epochs statistics using the :meth:``update_epochs_stats`` method.</span>
<span class="sd">        - The local epochs statistics dataframes are then appended to the list.</span>
<span class="sd">        - Finally, the list of dataframes is concatenated into a single dataframe.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create an empty list to store individual epochs statistics dataframes</span>
        <span class="n">lst_df</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># Iterate through each time series in the collection</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="c1"># Update epochs statistics for the current time series</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update_epochs_stats</span><span class="p">()</span>

            <span class="c1"># Append the epochs statistics dataframe to the list</span>
            <span class="n">lst_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">epochs_stats</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Concatenate the list of dataframes into a single dataframe</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">lst_df</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesCollection.get_epochs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.get_epochs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_epochs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate epochs for the time series data.</span>

<span class="sd">        :return: DataFrame with epochs information.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - This method merges the time series data to create a working DataFrame.</span>
<span class="sd">        - It creates a copy of the DataFrame for NaN-value calculation.</span>
<span class="sd">        - Converts non-NaN values to 1 and NaN values to 0.</span>
<span class="sd">        - Calculates the sum of non-NaN values for each row and updates the DataFrame with the result.</span>
<span class="sd">        - Extracts relevant columns for epoch calculation.</span>
<span class="sd">        - Sets 0 values in the specified ``overfield`` column to NaN.</span>
<span class="sd">        - Creates a new :class:`TimeSeries`` instance for epoch calculation using the ``overfield`` values.</span>
<span class="sd">        - Calculates epochs using the :meth:``get_epochs`` method of the new :class:`TimeSeries`` instance.</span>
<span class="sd">        - Updates the original DataFrame with the calculated epochs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Merge data to create a working DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_data</span><span class="p">()</span>

        <span class="c1"># Create a copy for nan-value calculation</span>
        <span class="n">df_nan</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Convert non-NaN values to 1, and NaN values to 0</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df_nan</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">df_nan</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nan</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Calculate the sum of non-NaN values for each row</span>
        <span class="n">df_nan</span> <span class="o">=</span> <span class="n">df_nan</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">overfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nan</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">overfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">overfield</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_nan</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># Extract relevant columns for epoch calculation</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overfield</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Set 0 values in the overfield column to NaN</span>
        <span class="n">df_aux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">overfield</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create a new TimeSeries instance for epoch calculation</span>
        <span class="n">ts_aux</span> <span class="o">=</span> <span class="n">TimeSeries</span><span class="p">()</span>
        <span class="n">ts_aux</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
            <span class="n">input_df</span><span class="o">=</span><span class="n">df_aux</span><span class="p">,</span>
            <span class="n">input_varfield</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">overfield</span><span class="p">,</span>
            <span class="n">input_dtfield</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">,</span>
            <span class="n">dropnan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Calculate epochs and update the original DataFrame</span>
        <span class="n">ts_aux</span><span class="o">.</span><span class="n">get_epochs</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Epoch_Id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_aux</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Epoch_Id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">return</span> <span class="n">df</span></div>


    <span class="c1"># View internal methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="TimeSeriesCollection._set_view_specs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection._set_view_specs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_view_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> | </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_object</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s2">&quot;width_spacing&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;xlabel&quot;</span><span class="p">:</span> <span class="s2">&quot;Date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ylabel&quot;</span><span class="p">:</span> <span class="s2">&quot;%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gantt&quot;</span><span class="p">:</span> <span class="s2">&quot;Gantt chart (epochs)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prev&quot;</span><span class="p">:</span> <span class="s2">&quot;Series prevalence&quot;</span><span class="p">,</span>
            <span class="s2">&quot;over&quot;</span><span class="p">:</span> <span class="s2">&quot;Overlapping data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vmin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;vmax&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;ymin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ymax&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># todo develop refactor to new view scheme (DRY)</span>
<div class="viewcode-block" id="TimeSeriesCollection.view">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.view">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;./output&quot;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">fig_format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
        <span class="n">suff</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">usealias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize the time series collection.</span>

<span class="sd">        :param show: bool, optional</span>
<span class="sd">            If True, the plot will be displayed interactively.</span>
<span class="sd">            If False, the plot will be saved to a file.</span>
<span class="sd">            Default is True.</span>
<span class="sd">        :type show: bool</span>

<span class="sd">        :param folder: str, optional</span>
<span class="sd">            The folder where the plot file will be saved. Used only if show is False.</span>
<span class="sd">            Default is &quot;./output&quot;.</span>
<span class="sd">        :type folder: str</span>

<span class="sd">        :param filename: str, optional</span>
<span class="sd">            The base name of the plot file. Used only if show is False. If None, a default filename is generated.</span>
<span class="sd">            Default is None.</span>
<span class="sd">        :type filename: str or None</span>

<span class="sd">        :param dpi: int, optional</span>
<span class="sd">            The dots per inch (resolution) of the plot file. Used only if show is False.</span>
<span class="sd">            Default is 300.</span>
<span class="sd">        :type dpi: int</span>

<span class="sd">        :param fig_format: str, optional</span>
<span class="sd">            The format of the plot file. Used only if show is False.</span>
<span class="sd">            Default is &quot;jpg&quot;.</span>
<span class="sd">        :type fig_format: str</span>

<span class="sd">        :param usealias: bool, optional</span>
<span class="sd">            Option for using the Alias instead of Name in the plot.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        :type usealias: bool</span>


<span class="sd">            If show is True, the plot is displayed interactively.</span>
<span class="sd">            If show is False, the plot is saved to a file.</span>


<span class="sd">        **Notes**</span>

<span class="sd">        This function generates a scatter plot with colored epochs based on the epochs&#39; start and end times.</span>
<span class="sd">        The plot includes data points within each epoch, and each epoch is labeled with its corresponding ID.</span>

<span class="sd">        **Examples**</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">usealias</span><span class="p">:</span>
            <span class="n">_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Alias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">dict_alias</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)):</span>
                <span class="n">dict_alias</span><span class="p">[</span><span class="n">_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_alias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># pre-processing</span>
        <span class="n">local_epochs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_local_epochs</span><span class="p">()</span>
        <span class="c1"># Aggregate sum based on the &#39;Name&#39; field</span>
        <span class="n">agg_df</span> <span class="o">=</span> <span class="n">local_epochs_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)[</span><span class="s2">&quot;Epochs_n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">agg_df</span> <span class="o">=</span> <span class="n">agg_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Epochs_n&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">agg_df</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">usealias</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="p">[</span><span class="n">dict_alias</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
        <span class="n">preval</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">agg_df</span><span class="p">[</span><span class="s2">&quot;Epochs_n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">agg_df</span><span class="p">[</span><span class="s2">&quot;Epochs_n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">heights</span> <span class="o">=</span> <span class="n">heights</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)]</span> <span class="o">+</span> <span class="p">((</span><span class="n">heights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">heights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># get epochs</span>
        <span class="n">epochs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_epochs</span><span class="p">()</span>

        <span class="c1"># Assuming date_values is a list of datetime objects</span>
        <span class="n">date_values</span> <span class="o">=</span> <span class="n">epochs_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># Calculate the number of ticks you want (e.g., 5)</span>
        <span class="n">num_ticks</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c1"># Calculate the step size to evenly space the ticks</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_values</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">num_ticks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Generate indices for the ticks</span>
        <span class="n">tick_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_values</span><span class="p">),</span> <span class="n">step_size</span><span class="p">)</span>
        <span class="c1"># Select the corresponding dates for the ticks</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">date_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tick_indices</span><span class="p">]</span>

        <span class="c1"># plot</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Deploy figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]))</span>  <span class="c1"># Width, Height</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="n">wspace</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;width_spacing&quot;</span><span class="p">],</span>
            <span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">left</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">],</span>
            <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">top</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
            <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>

        <span class="c1"># Gantt chart</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;a. </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;gantt&quot;</span><span class="p">]),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">df_aux</span> <span class="o">=</span> <span class="n">local_epochs_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name == &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_aux</span><span class="p">)):</span>
                <span class="n">x_time</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_aux</span><span class="p">[</span><span class="s2">&quot;Start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">df_aux</span><span class="p">[</span><span class="s2">&quot;End&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                <span class="n">y_height</span> <span class="o">=</span> <span class="p">[</span><span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">heights</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">x_time</span><span class="p">,</span>
                    <span class="n">y_height</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">df_aux</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                    <span class="n">solid_capstyle</span><span class="o">=</span><span class="s2">&quot;butt&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">names</span>
        <span class="k">if</span> <span class="n">usealias</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">alias</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">heights</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xlabel&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># overlapping chart</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;code. </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;over&quot;</span><span class="p">]),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">epochs_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">],</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">epochs_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">overfield</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">epochs_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">],</span>
            <span class="mi">100</span> <span class="o">*</span> <span class="n">epochs_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">overfield</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">105</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xlabel&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>

        <span class="c1"># Prevalence chart</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">:])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;b. </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;prev&quot;</span><span class="p">]),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
            <span class="n">labels</span><span class="p">,</span>
            <span class="n">preval</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:gray&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Add data values as text labels on the bars</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">preval</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span>
                <span class="n">index</span><span class="p">,</span>
                <span class="s2">&quot; </span><span class="si">{:.1f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>

        <span class="c1"># show or save</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">suff</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fig_format</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># todo develop refactor to new view scheme</span>
<div class="viewcode-block" id="TimeSeriesCollection.export_views">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.export_views">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_views</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">fig_format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="n">suff</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">skip_main</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export views of time series data and individual time series within the collection.</span>

<span class="sd">        :param folder: The folder path where the views will be exported.</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param dpi: Dots per inch (resolution) for the exported images, default is 300.</span>
<span class="sd">        :type dpi: int</span>
<span class="sd">        :param fig_format: Format for the exported figures, default is &quot;jpg&quot;.</span>
<span class="sd">        :type fig_format: str</span>
<span class="sd">        :param suff: Suffix to be appended to the exported file names, default is an empty string.</span>
<span class="sd">        :type suff: str</span>
<span class="sd">        :param skip_main: Option for skipping the main plot (pannel)</span>
<span class="sd">        :type skip_main: bool</span>
<span class="sd">        :param raw: Option for considering a raw data series. No epochs analysis. Default is False.</span>
<span class="sd">        :type raw: str</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - Updates the collection details and epoch statistics.</span>
<span class="sd">        - Calls the ``view`` method for the entire collection and individual time series with specified parameters.</span>
<span class="sd">        - Sets view specifications for individual time series, such as y-axis limits and time range.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update_epochs_stats</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">skip_main</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">fig_format</span><span class="o">=</span><span class="n">fig_format</span><span class="p">,</span> <span class="n">suff</span><span class="o">=</span><span class="n">suff</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="c1"># specs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_max</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
            <span class="c1"># view</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># todo docstring</span>
<div class="viewcode-block" id="TimeSeriesCollection.export_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCollection.export_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">merged</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">merged</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_epochs</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_local_epochs</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_epochs.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TimeSeriesCluster">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCluster">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimeSeriesCluster</span><span class="p">(</span><span class="n">TimeSeriesCollection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ``TimeSeriesCluster`` instance is desgined for holding a collection</span>
<span class="sd">    of same variable time series. That is, no miscellaneus data is allowed.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimeSeriesCluster.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesCluster.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;myTimeSeriesCluster&quot;</span><span class="p">,</span> <span class="n">base_object</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># initialize parent</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">base_object</span><span class="o">=</span><span class="n">base_object</span><span class="p">)</span>

        <span class="c1"># Set extra specific attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varname</span> <span class="o">=</span> <span class="n">base_object</span><span class="p">()</span><span class="o">.</span><span class="n">varname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span> <span class="o">=</span> <span class="n">base_object</span><span class="p">()</span><span class="o">.</span><span class="n">varalias</span>

        <span class="c1"># Overwrite parent attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_object</span> <span class="o">=</span> <span class="s2">&quot;Time Series Cluster&quot;</span></div>
</div>



<div class="viewcode-block" id="TimeSeriesSamples">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimeSeriesSamples</span><span class="p">(</span><span class="n">TimeSeriesCluster</span><span class="p">):</span>
    <span class="c1"># todo improve docstring</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ``TimeSeriesSamples`` instance is desgined for holding a collection</span>
<span class="sd">    of same variable time series arising from the same underlying process.</span>
<span class="sd">    This means that all elements in the collection are statistical data.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This instance allows for the ``reducer()`` method.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimeSeriesSamples.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;myTimeSeriesSamples&quot;</span><span class="p">,</span> <span class="n">base_object</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="c1"># initialize parent</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">base_object</span><span class="o">=</span><span class="n">base_object</span><span class="p">)</span>
        <span class="c1"># Overwrite parent attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_object</span> <span class="o">=</span> <span class="s2">&quot;Time Series Samples&quot;</span></div>


<div class="viewcode-block" id="TimeSeriesSamples.reducer">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.reducer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reducer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reducer_funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stepwise</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>

        <span class="n">df_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_data</span><span class="p">()</span>

        <span class="c1"># set up output dict</span>
        <span class="n">dict_out</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">:</span> <span class="n">df_merged</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}</span>

        <span class="c1"># get grid</span>
        <span class="n">grd_data</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">[</span><span class="n">df_merged</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">for</span> <span class="n">funcname</span> <span class="ow">in</span> <span class="n">reducer_funcs</span><span class="p">:</span>
            <span class="c1"># set array</span>
            <span class="n">vct_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_merged</span><span class="p">))</span>
            <span class="c1"># row loop options</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">reducer_funcs</span><span class="p">[</span><span class="n">funcname</span><span class="p">][</span><span class="s2">&quot;Args&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vct_red</span><span class="p">)):</span>
                        <span class="n">vct_red</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">reducer_funcs</span><span class="p">[</span><span class="n">funcname</span><span class="p">][</span><span class="s2">&quot;Func&quot;</span><span class="p">](</span><span class="n">grd_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vct_red</span> <span class="o">=</span> <span class="n">reducer_funcs</span><span class="p">[</span><span class="n">funcname</span><span class="p">][</span><span class="s2">&quot;Func&quot;</span><span class="p">](</span><span class="n">grd_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stepwise</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vct_red</span><span class="p">)):</span>
                        <span class="n">vct_red</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">reducer_funcs</span><span class="p">[</span><span class="n">funcname</span><span class="p">][</span><span class="s2">&quot;Func&quot;</span><span class="p">](</span><span class="n">grd_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vct_red</span> <span class="o">=</span> <span class="n">reducer_funcs</span><span class="p">[</span><span class="n">funcname</span><span class="p">][</span><span class="s2">&quot;Func&quot;</span><span class="p">](</span><span class="n">grd_data</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># append to dict</span>
            <span class="n">dict_out</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varalias</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vct_red</span><span class="p">[:]</span>

        <span class="c1"># set dataframe</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dict_out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesSamples.mean">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.mean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">(</span><span class="n">reducer_funcs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesSamples.rng">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.rng">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">(</span><span class="n">reducer_funcs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rng&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesSamples.std">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.std">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">(</span><span class="n">reducer_funcs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesSamples.min">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.min">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">(</span><span class="n">reducer_funcs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesSamples.max">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.max">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">(</span><span class="n">reducer_funcs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesSamples.percentile">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.percentile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">percentile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">(</span><span class="n">reducer_funcs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">}})</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesSamples.percentiles">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.percentiles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">percentiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">99</span><span class="p">]</span>
        <span class="n">dict_funcs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">dict_funcs</span><span class="p">[</span><span class="s2">&quot;p0</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dict_funcs</span><span class="p">[</span><span class="s2">&quot;p0</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">(</span><span class="n">reducer_funcs</span><span class="o">=</span><span class="n">dict_funcs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TimeSeriesSamples.stats">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSamples.stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">(</span>
            <span class="n">reducer_funcs</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;sum&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Func&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="s2">&quot;Args&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">basic</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">]</span>
        <span class="c1"># get percentiles</span>
        <span class="n">df_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentiles</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># join dataframes</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">df_stats</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">df_per</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtfield</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>
</div>



<div class="viewcode-block" id="TimeSeriesSpatialSamples">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSpatialSamples">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimeSeriesSpatialSamples</span><span class="p">(</span><span class="n">TimeSeriesSamples</span><span class="p">):</span>
    <span class="c1"># todo improve docstring</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ``TimeSeriesSpatialSamples`` instance is desgined for holding a collection</span>
<span class="sd">    of same variable time series arising from the same underlying process in space.</span>
<span class="sd">    This means that all elements in the collection are statistical data in space.</span>

<span class="sd">    .. note::</span>

<span class="sd">        This instance allows for the ``regionalize()`` method.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimeSeriesSpatialSamples.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSpatialSamples.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;myTimeSeriesSpatialSample&quot;</span><span class="p">,</span> <span class="n">base_object</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="c1"># initialize parent</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">base_object</span><span class="o">=</span><span class="n">base_object</span><span class="p">)</span>
        <span class="c1"># Overwrite parent attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_object</span> <span class="o">=</span> <span class="s2">&quot;Time Series Spatial&quot;</span></div>


<div class="viewcode-block" id="TimeSeriesSpatialSamples.get_weights_by_name">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSpatialSamples.get_weights_by_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_weights_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">):</span>
        <span class="c1"># todo [docstring]</span>
        <span class="c1"># remaining names</span>
        <span class="n">df_remain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Name != &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">list_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_remain</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># w array</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_names</span><span class="p">))</span>

        <span class="c1"># handle methods</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;average&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">w</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;idw&quot;</span><span class="p">:</span>
            <span class="c1"># Get x,y</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
            <span class="c1"># Get distances</span>
            <span class="n">x_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">list_names</span><span class="p">])</span>
            <span class="n">y_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">list_names</span><span class="p">])</span>
            <span class="n">d_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_i</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_i</span><span class="p">))</span>
            <span class="c1"># Compute IDW</span>
            <span class="n">idw_i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">d_i</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d_i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">))</span>  <span class="c1"># handle zero distance</span>
            <span class="c1"># Normaliza to [0-100] range</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">idw_i</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idw_i</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">w</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">w</span></div>


    <span class="c1"># docs ok</span>
<div class="viewcode-block" id="TimeSeriesSpatialSamples.regionalize">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.TimeSeriesSpatialSamples.regionalize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">regionalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regionalize the time series data using a specified method.</span>

<span class="sd">        :param method: Method for regionalization, default is &quot;average&quot;.</span>
<span class="sd">        :type method: str</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - This method handles standardization. If the time series data is not standardized, it applies standardization.</span>
<span class="sd">        - Computes epochs for the time series data.</span>
<span class="sd">        - Iterates through each time series in the collection and performs regionalization.</span>
<span class="sd">        - For each time series, sets up source and destination vectors, computes weights, and calculates regionalized values.</span>
<span class="sd">        - Updates the destination column in-place with the regionalized values and updates epochs statistics.</span>
<span class="sd">        - Updates the collection catalog with details.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle stardardization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isstandard</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">()</span>
        <span class="c1"># Compute Epochs</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_epochs</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)):</span>

            <span class="n">varfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;VarField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
                <span class="n">i</span>
            <span class="p">]</span>  <span class="c1"># todo refactor fields (avoid hardcoded)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">df_src_catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Name != &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

            <span class="c1"># Get destination vector</span>
            <span class="n">dst_vct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">dst_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dst_vct</span><span class="p">)</span>

            <span class="c1"># Set up source</span>
            <span class="n">src_vars</span> <span class="o">=</span> <span class="n">df_src_catalog</span><span class="p">[</span><span class="s2">&quot;VarField&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">src_names</span> <span class="o">=</span> <span class="n">df_src_catalog</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">src_alias</span> <span class="o">=</span> <span class="n">df_src_catalog</span><span class="p">[</span><span class="s2">&quot;Alias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">src_columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_vars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">src_alias</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_src_catalog</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">df_src</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">src_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># ensure name order</span>

            <span class="c1"># Set up weights</span>
            <span class="n">vct_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_weights_by_name</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

            <span class="c1"># get product w * values</span>
            <span class="n">w_v</span> <span class="o">=</span> <span class="n">vct_w</span> <span class="o">*</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df_src</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="c1"># horizontal weights sum</span>
            <span class="n">w_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">w_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">w_sum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">w_sum</span><span class="p">)</span>
            <span class="c1"># output sum</span>
            <span class="n">o_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">df_src</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">w_v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># output average</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">o_sum</span> <span class="o">/</span> <span class="n">w_sum</span>

            <span class="c1"># set destination column inplace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">varfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dst_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">dst_vct</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update_epochs_stats</span><span class="p">()</span>

        <span class="c1"># Update the collection catalog with details</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</div>



<span class="c1"># Core spatial classes</span>
<span class="c1"># -----------------------------------------------------------------------</span>


<div class="viewcode-block" id="Raster">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Raster</span><span class="p">(</span><span class="n">DataSet</span><span class="p">):</span>
    <span class="c1"># todo[docstring] -- examples</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The basic Raster map dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Dunder methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="Raster.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;myRasterMap&quot;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;Rst&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;xllcorner&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;yllcorner&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;cellsize&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;NODATA_value&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span>
        <span class="c1"># extra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;Unknown variable&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span> <span class="o">=</span> <span class="s2">&quot;UnVar&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># &quot;2020-01-01&quot;</span>

        <span class="c1"># ------------ call super ----------- #</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">)</span>
        <span class="c1"># -------------------------------------</span>
        <span class="c1"># set basic attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_masked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_prj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># accessible values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;cellsize&quot;</span><span class="p">]</span>
        <span class="c1"># stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dct_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
        <span class="n">lst_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">lst_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lst_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Object: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="n">lst_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Metadata:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dct_meta</span><span class="p">:</span>
            <span class="n">lst_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dct_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst_</span><span class="p">)</span>

    <span class="c1"># Core internal methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="Raster._set_fields">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster._set_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set fields names.</span>
<span class="sd">        Expected to increment superior methods.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ------------ call super ----------- #</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_fields</span><span class="p">()</span>
        <span class="c1"># Attribute fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_varname</span> <span class="o">=</span> <span class="s2">&quot;var_name&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_varalias</span> <span class="o">=</span> <span class="s2">&quot;var_alias&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_units</span> <span class="o">=</span> <span class="s2">&quot;units&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span> <span class="o">=</span> <span class="s2">&quot;datetime&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_cellsize</span> <span class="o">=</span> <span class="s2">&quot;resolution&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_nrows</span> <span class="o">=</span> <span class="s2">&quot;rows&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_ncols</span> <span class="o">=</span> <span class="s2">&quot;columns&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_xll</span> <span class="o">=</span> <span class="s2">&quot;xll&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_yll</span> <span class="o">=</span> <span class="s2">&quot;yll&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_nodatavalue</span> <span class="o">=</span> <span class="s2">&quot;nodata_value&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_crs</span> <span class="o">=</span> <span class="s2">&quot;crs&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_epsg</span> <span class="o">=</span> <span class="s2">&quot;epsg&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_file_prj</span> <span class="o">=</span> <span class="s2">&quot;file_prj&quot;</span></div>

        <span class="c1"># ... continues in downstream objects ... #</span>

    <span class="c1"># Get methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster.get_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.get_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a dictionary with object metadata.</span>
<span class="sd">        Expected to increment superior methods.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Metadata does **not** necessarily inclue all object attributes.</span>

<span class="sd">        :return: dictionary with all metadata</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ------------ call super ----------- #</span>
        <span class="n">dict_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>

        <span class="c1"># customize local metadata:</span>
        <span class="n">dict_meta_local</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_varname</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_varalias</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_units</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_cellsize</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;cellsize&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_nrows</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;nrows&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_ncols</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;ncols&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_xll</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;xllcorner&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_yll</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;yllcorner&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_nodatavalue</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="c1"># update</span>
        <span class="n">dict_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dict_meta_local</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_meta</span></div>


<div class="viewcode-block" id="Raster.get_bbox">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.get_bbox">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Bounding Box of the map.</span>

<span class="sd">        :return: Dictionary of xmin, xmax, ymin, and ymax.</span>
<span class="sd">            - &quot;xmin&quot; (float): Minimum x-coordinate.</span>
<span class="sd">            - &quot;xmax&quot; (float): Maximum x-coordinate.</span>
<span class="sd">            - &quot;ymin&quot; (float): Minimum y-coordinate.</span>
<span class="sd">            - &quot;ymax&quot; (float): Maximum y-coordinate.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;xmin&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;xllcorner&quot;</span><span class="p">],</span>
            <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;xllcorner&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;ncols&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span><span class="p">),</span>
            <span class="s2">&quot;ymin&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;yllcorner&quot;</span><span class="p">],</span>
            <span class="s2">&quot;ymax&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;yllcorner&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;nrows&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span><span class="p">),</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Raster.get_extent">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.get_extent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_extent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Extent of the map. See get_bbox.</span>

<span class="sd">        :return: list of [xmin, xmax, ymin, ymax]</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bbox</span><span class="p">()</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">extent</span></div>


<div class="viewcode-block" id="Raster.get_grid_datapoints">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.get_grid_datapoints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_datapoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drop_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get flat and cleared grid data points (x, y, and z).</span>

<span class="sd">        **Notes**</span>
<span class="sd">        This function extracts coordinates (x, y, and z) from the raster grid.</span>
<span class="sd">        The x and y coordinates are determined based on the grid cell center positions.</span>
<span class="sd">        If drop_nan is True, nan values are ignored in the resulting DataFrame.</span>
<span class="sd">        The resulting DataFrame includes columns for x, y, z, i, and j coordinates.</span>

<span class="sd">        :param drop_nan: Option to ignore nan values.</span>
<span class="sd">        :type drop_nan: bool</span>
<span class="sd">        :return: DataFrame of x, y, and z fields.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame``` or None. If the grid is None, returns None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get coordinates</span>
            <span class="n">vct_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">vct_j</span> <span class="o">=</span> <span class="n">vct_i</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vct_z</span> <span class="o">=</span> <span class="n">vct_i</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">_c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                    <span class="n">vct_i</span><span class="p">[</span><span class="n">_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">vct_j</span><span class="p">[</span><span class="n">_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="n">vct_z</span><span class="p">[</span><span class="n">_c</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">_c</span> <span class="o">=</span> <span class="n">_c</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># transform</span>
            <span class="n">n_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span>
            <span class="n">vct_y</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;yllcorner&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">n_height</span> <span class="o">-</span> <span class="p">(</span><span class="n">vct_i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span><span class="p">))</span>
                <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">vct_x</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;xllcorner&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">vct_j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># drop nan or masked values:</span>
            <span class="k">if</span> <span class="n">drop_nan</span><span class="p">:</span>
                <span class="n">vct_j</span> <span class="o">=</span> <span class="n">vct_j</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vct_z</span><span class="p">)]</span>
                <span class="n">vct_i</span> <span class="o">=</span> <span class="n">vct_i</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vct_z</span><span class="p">)]</span>
                <span class="n">vct_x</span> <span class="o">=</span> <span class="n">vct_x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vct_z</span><span class="p">)]</span>
                <span class="n">vct_y</span> <span class="o">=</span> <span class="n">vct_y</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vct_z</span><span class="p">)]</span>
                <span class="n">vct_z</span> <span class="o">=</span> <span class="n">vct_z</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vct_z</span><span class="p">)]</span>
            <span class="c1"># built dataframe</span>
            <span class="n">_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">vct_x</span><span class="p">,</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">vct_y</span><span class="p">,</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">vct_z</span><span class="p">,</span>
                    <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">vct_i</span><span class="p">,</span>
                    <span class="s2">&quot;j&quot;</span><span class="p">:</span> <span class="n">vct_j</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">_df</span></div>


<div class="viewcode-block" id="Raster.get_grid_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.get_grid_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get flat and cleared grid values.</span>

<span class="sd">        :return: 1D vector of cleared sample.</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`` or None. If the grid is None, returns None.</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - This function extracts and flattens the grid, removing any masked or NaN values.</span>
<span class="sd">        - For integer grids, the masked values are ignored.</span>
<span class="sd">        - For floating-point grids, both masked and NaN values are ignored.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">]:</span>
                <span class="c1"># for integer grid</span>
                <span class="n">_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">_grid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for floating point grid:</span>
                <span class="n">_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">())]</span>
                <span class="k">return</span> <span class="n">_grid</span></div>


<div class="viewcode-block" id="Raster.get_univar">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.get_univar">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_univar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates and returns a Univar object initialized with the current object&#39;s grid data.</span>

<span class="sd">        :return: A Univar object containing the grid data for univariate analysis.</span>
<span class="sd">        :rtype: :class:`plans.analyst.Univar`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">plans.analyst</span><span class="w"> </span><span class="kn">import</span> <span class="n">Univar</span>

        <span class="n">uni</span> <span class="o">=</span> <span class="n">Univar</span><span class="p">()</span>
        <span class="n">uni</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_grid_data</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">uni</span></div>


<div class="viewcode-block" id="Raster.get_stats">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.get_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get basic statistics from flat and cleared grid.</span>

<span class="sd">        :return: Dict of basic statistics. If the grid is None, returns None.</span>
<span class="sd">        :rtype: dict or None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats_df</span><span class="p">()</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row_dict</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">):</span>
            <span class="n">dc</span><span class="p">[</span><span class="n">row_dict</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row_dict</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">dc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dc</span></div>


<div class="viewcode-block" id="Raster.get_stats_df">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.get_stats_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get :class:`pandas.DataFrame` statistics from flat and cleared grid.</span>

<span class="sd">        :return: DataFrame of basic statistics. If the grid is None, returns None.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame` or None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_univar</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">uni</span><span class="o">.</span><span class="n">assess_basic_stats</span><span class="p">()</span></div>


<div class="viewcode-block" id="Raster.get_aoi">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.get_aoi">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_aoi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by_value_lo</span><span class="p">,</span> <span class="n">by_value_hi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the AOI map from an interval of values (values are expected to exist in the raster).</span>

<span class="sd">        :param by_value_lo: Number for the lower bound (inclusive).</span>
<span class="sd">        :type by_value_lo: float</span>
<span class="sd">        :param by_value_hi: Number for the upper bound (inclusive).</span>
<span class="sd">        :type by_value_hi: float</span>
<span class="sd">        :return: AOI map.</span>
<span class="sd">        :rtype: :class:`AOI`` object</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - This function creates an AOI (Area of Interest) map based on a specified value range.</span>
<span class="sd">        - The AOI map is constructed as a binary grid where values within the specified range are set to 1, and others to 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">map_aoi</span> <span class="o">=</span> <span class="n">AOI</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span> <span class="n">by_value_lo</span><span class="p">,</span> <span class="n">by_value_hi</span><span class="p">))</span>
        <span class="n">map_aoi</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">)</span>
        <span class="n">map_aoi</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prj</span>
        <span class="c1"># set grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_nodata</span><span class="p">()</span>
        <span class="n">map_aoi</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
            <span class="n">grid</span><span class="o">=</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">by_value_lo</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">by_value_hi</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_nodata</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">map_aoi</span></div>


    <span class="c1"># Core methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster.update">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refresh all mutable attributes based on data (includins paths).</span>
<span class="sd">        Expected to be incremented downstream.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="c1"># refresh all mutable attributes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># data size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;nrows&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;ncols&quot;</span><span class="p">]</span>

        <span class="c1"># raster metadata attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;cellsize&quot;</span><span class="p">]</span>

        <span class="c1"># ... continues in downstream objects ... #</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.set_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.set_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the data grid for the raster object.</span>
<span class="sd">        This function allows setting the data grid for the raster object.</span>
<span class="sd">        The incoming grid should be a NumPy array.</span>

<span class="sd">        :param grid: The data grid to be set for the raster.</span>
<span class="sd">        :type grid: :class:`numpy.ndarray`</span>

<span class="sd">        **Notes**</span>

<span class="sd">        - The function overwrites the existing data grid in the raster object with the incoming grid, ensuring that the data type matches the raster&#39;s dtype.</span>
<span class="sd">        - Nodata values are masked after setting the grid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># overwrite incoming dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1"># mask nodata values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_nodata</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.set_raster_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.set_raster_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_raster_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set metadata for the raster object based on incoming metadata.</span>
<span class="sd">        This function allows setting metadata for the raster object from an incoming metadata dictionary.</span>
<span class="sd">        The metadata should include information such as the number of columns, number of rows, corner coordinates, cell size, and nodata value.</span>

<span class="sd">        :param metadata: A dictionary containing metadata for the raster.</span>
<span class="sd">        :type metadata: dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># Load data methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">file_prj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data and metadata from files to the Raster object.</span>

<span class="sd">        :param file_data: The path to the raster file.</span>
<span class="sd">        :type file_data: str</span>
<span class="sd">        :param file_prj: The path to the &#39;.prj&#39; projection file. If not provided, an attempt is made to use the same path and name as the ``.asc`` file with the &#39;.prj&#39; extension.</span>
<span class="sd">        :type file_prj: str</span>
<span class="sd">        :param id_band: Band id to read for GeoTIFF. Default value = 1</span>
<span class="sd">        :type id_band: int</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle extension</span>
        <span class="n">s_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s_extension</span> <span class="o">==</span> <span class="s2">&quot;asc&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_asc</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_tif</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="n">id_band</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_prj</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_prj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_data</span> <span class="o">=</span> <span class="n">file_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.load_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.load_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load only metadata from files to the raster object.</span>

<span class="sd">        :param file_data: The path to the raster file.</span>
<span class="sd">        :type file_data: str</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle extension</span>
        <span class="n">s_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s_extension</span> <span class="o">==</span> <span class="s2">&quot;asc&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_asc_metadata</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_tif_metadata</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="n">id_band</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.load_image">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.load_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_input</span><span class="p">,</span> <span class="n">xxl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data from an image &#39;.tif&#39; raster files.</span>

<span class="sd">        :param file_input: The file path of the &#39;.tif&#39; raster file.</span>
<span class="sd">        :type file_input: str</span>
<span class="sd">        :param xxl: option flag for very large images</span>
<span class="sd">        :type xxl: bool</span>



<span class="sd">        **Notes**</span>

<span class="sd">        - The function uses the Pillow (PIL) library to open the &#39;.tif&#39; file and converts it to a NumPy array.</span>
<span class="sd">        - Metadata may need to be provided separately, as this function focuses on loading raster data.</span>
<span class="sd">        - The loaded data grid is set using the ``set_grid`` method of the raster object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

        <span class="k">if</span> <span class="n">xxl</span><span class="p">:</span>
            <span class="n">Image</span><span class="o">.</span><span class="n">MAX_IMAGE_PIXELS</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Open the TIF file</span>
        <span class="n">img_data</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">)</span>
        <span class="c1"># Convert the PIL image to a NumPy array</span>
        <span class="n">grd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>
        <span class="c1"># set grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grd_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.load_tif">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.load_tif">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_tif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_input</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data and metadata from `.tif` raster file.</span>

<span class="sd">        :param file_input: The file path to the ``.tif`` raster file.</span>
<span class="sd">        :type file_input: str</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dc_raster</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">read_tif</span><span class="p">(</span>
            <span class="n">file_input</span><span class="o">=</span><span class="n">file_input</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="n">id_band</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># Set metadata and grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">dc_raster</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">dc_raster</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.load_tif_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.load_tif_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_tif_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_input</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load only metadata from `.tif` raster file.</span>

<span class="sd">        :param file_input: The file path to the ``.tif`` raster file.</span>
<span class="sd">        :type file_input: str</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dc_metadata</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">read_tif_metadata</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_input</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="n">id_band</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">dc_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.load_asc">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.load_asc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_asc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_input</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data and metadata from `.asc` raster file.</span>

<span class="sd">        :param file_input: The file path to the ``.asc`` raster file.</span>
<span class="sd">        :type file_input: str</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dc_raster</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">read_asc</span><span class="p">(</span>
            <span class="n">file_input</span><span class="o">=</span><span class="n">file_input</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># Set metadata and grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">dc_raster</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">dc_raster</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.load_asc_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.load_asc_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_asc_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_input</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load only metadata from ``.asc`` raster files.</span>

<span class="sd">        :param file_input: The file path to the ``.asc`` raster file.</span>
<span class="sd">        :type file_input: str</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta_dct</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">read_asc_metadata</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_input</span><span class="p">)</span>
        <span class="c1"># set attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">meta_dct</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.load_prj">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.load_prj">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_prj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_input</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load &#39;.prj&#39; auxiliary file to the &#39;prj&#39; attribute.</span>

<span class="sd">        :param file_input: The file path to the &#39;.prj&#39; auxiliary file.</span>
<span class="sd">        :type file_input: str</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># handle expected file</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_input</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_prj</span> <span class="o">=</span> <span class="n">file_input</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.copy_structure">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.copy_structure">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raster_ref</span><span class="p">,</span> <span class="n">n_nodatavalue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy structure (metadata and prj) from another raster object.</span>

<span class="sd">        :param raster_ref: The reference incoming raster object from which to copy.</span>
<span class="sd">        :type raster_ref: :class:`datasets.Raster`</span>
<span class="sd">        :param n_nodatavalue: The new nodata value for different raster objects. If None, the nodata value remains unchanged.</span>
<span class="sd">        :type n_nodatavalue: float</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dict_meta</span> <span class="o">=</span> <span class="n">raster_ref</span><span class="o">.</span><span class="n">raster_metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># handle new nodatavalue</span>
        <span class="k">if</span> <span class="n">n_nodatavalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dict_meta</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_nodatavalue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">dict_meta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="n">raster_ref</span><span class="o">.</span><span class="n">prj</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># Export methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster.export">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.export">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;tif&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exports the raster to a specified file format and location.</span>

<span class="sd">        :param folder: The destination folder for the exported file.</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: [optional] The name of the output file. If None, the original raster name is used.</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param mode: The export format, either &quot;tif&quot; (default) or &quot;asc&quot;. Default value = &quot;tif&quot;</span>
<span class="sd">        :type mode: str</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># handle mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;asc&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_asc</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_tif</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># export prj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_prj</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.export_tif">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.export_tif">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_tif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export an ``.tif`` raster file..</span>

<span class="sd">        :param folder: The directory path to export the raster file.</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: The name of the exported file without extension. If None, the name of the raster object is used.</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: The full file name (path and extension) of the exported raster file.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">flenm</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span>
            <span class="n">Raster</span><span class="o">.</span><span class="n">write_tif</span><span class="p">(</span>
                <span class="n">grid_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">dc_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">,</span>
                <span class="n">file_output</span><span class="o">=</span><span class="n">flenm</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">n_bands</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">id_band</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">flenm</span></div>


<div class="viewcode-block" id="Raster.export_asc">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.export_asc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_asc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export an ``.asc`` raster file.</span>

<span class="sd">        :param folder: The directory path to export the raster file.</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: The name of the exported file without extension. If None, the name of the raster object is used.</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: The full file name (path and extension) of the exported raster file.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">flenm</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.asc&quot;</span>
            <span class="n">Raster</span><span class="o">.</span><span class="n">write_asc</span><span class="p">(</span>
                <span class="n">grid_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">dc_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">,</span>
                <span class="n">file_output</span><span class="o">=</span><span class="n">flenm</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">flenm</span></div>


<div class="viewcode-block" id="Raster.export_prj">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.export_prj">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_prj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export a &#39;.prj&#39; file. This function exports the coordinate system information to a &#39;.prj&#39; file in the specified folder.</span>

<span class="sd">        :param folder: The directory path to export the &#39;.prj&#39; file.</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: The name of the exported file without extension. If None, the name of the raster object is used.</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: The full file name (path and extension) of the exported &#39;.prj&#39; file, or None if no coordinate system information is available.</span>
<span class="sd">        :rtype: str or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">flenm</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.prj&quot;</span>
            <span class="n">fle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">flenm</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
            <span class="n">fle</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prj</span><span class="p">])</span>
            <span class="n">fle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">flenm</span></div>


    <span class="c1"># Nodata methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster.reset_nodata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.reset_nodata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_nodata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_nodata</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the no-data value in the raster metadata and updates the data mask accordingly.</span>

<span class="sd">        This method first ensures the current no-data values are masked, then updates the</span>
<span class="sd">        `NODATA_value` in the raster metadata, and finally re-applies the mask based on the new no-data value.</span>

<span class="sd">        :param new_nodata: The new no-data value to set.</span>
<span class="sd">        :type new_nodata: int or float</span>
<span class="sd">        :param ensure: If True, ensures the current no-data values are masked before resetting. Default value = True</span>
<span class="sd">        :type ensure: bool</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ensure current nodata is masked</span>
        <span class="k">if</span> <span class="n">ensure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_nodata</span><span class="p">()</span>
        <span class="c1"># reset in metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_nodata</span>
        <span class="c1"># de-mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_nodata</span><span class="p">()</span>
        <span class="c1"># mask again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_nodata</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.mask_nodata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.mask_nodata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mask_nodata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mask grid cells as NaN where data is NODATA.</span>




<span class="sd">        **Notes**</span>

<span class="sd">        - The function masks grid cells as NaN where the data is equal to the specified NODATA value.</span>
<span class="sd">        - If NODATA value is not set, no masking is performed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">]:</span>
                <span class="c1"># for integer grid</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for floating point grid:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.insert_nodata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.insert_nodata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert_nodata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set grid cells as NODATA where data is NaN using the static method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Call the static method and update the instance&#39;s grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">apply_nodata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># AOI methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster.load_aoi_mask">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.load_aoi_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_aoi_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_raster</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads an Area of Interest (AOI) mask from a raster file and applies it to the current object&#39;s data.</span>

<span class="sd">        :param file_raster: The file path to the AOI raster.</span>
<span class="sd">        :type file_raster: str</span>
<span class="sd">        :param inplace: If True, the mask is applied in-place to the current object&#39;s data. Default value = False</span>
<span class="sd">        :type inplace: bool</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">plans.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">AOI</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">AOI</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">file_data</span><span class="o">=</span><span class="n">file_raster</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_aoi_mask</span><span class="p">(</span><span class="n">grid_aoi</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">r</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.apply_aoi_mask">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.apply_aoi_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_aoi_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_aoi</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply AOI (area of interest) mask to the raster map.</span>
<span class="sd">        This function applies an AOI (area of interest) mask to the raster map,</span>
<span class="sd">        replacing values outside the AOI with the NODATA value.</span>

<span class="sd">        **Notes**</span>
<span class="sd">        The function replaces values outside the AOI (where grid_aoi is 0) with the NODATA value.</span>
<span class="sd">        If NODATA value is not set, no replacement is performed.</span>
<span class="sd">        If inplace is True, the main grid is modified. If False, a backup of the grid is created before modification.</span>
<span class="sd">        This function is useful for focusing analysis or visualization on a specific area within the raster map.</span>

<span class="sd">        :param grid_aoi: Map of AOI (masked array or pseudo-boolean). Expected to have the same grid shape as the raster.</span>
<span class="sd">        :type grid_aoi: :class:`numpy.ndarray`</span>
<span class="sd">        :param inplace: If True, overwrite the main grid with the masked values.</span>
<span class="sd">            If False, create a backup and modify a copy of the grid. Default is False.</span>
<span class="sd">        :type inplace: bool</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ensure fill on masked values</span>
            <span class="n">grid_aoi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">grid_aoi</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># replace</span>
            <span class="n">grd_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">grid_aoi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># pass a copy to backup grid</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># set main grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grd_mask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_masked</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Raster.release_aoi_mask">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.release_aoi_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">release_aoi_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release AOI mask from the main grid. Backup grid is restored.</span>

<span class="sd">        This function releases the AOI (area of interest) mask from the main grid,</span>
<span class="sd">        restoring the original values from the backup grid.</span>

<span class="sd">        **Notes**</span>
<span class="sd">        If an AOI mask has been applied, this function restores the original values to the main grid from the backup grid.</span>
<span class="sd">        If no AOI mask has been applied, the function has no effect.</span>
<span class="sd">        After releasing the AOI mask, the backup grid is set to None, and the raster object is no longer considered to have an AOI mask.</span>




<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_masked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backup_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_masked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># Transformation methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster.rebase_grid">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.rebase_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rebase_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_raster</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear_model&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rebase the grid of a raster.</span>
<span class="sd">        This function creates a new grid based on a provided reference raster.</span>
<span class="sd">        Both rasters are expected to be in the same coordinate system and have overlapping bounding boxes.</span>

<span class="sd">        :param base_raster: The reference raster used for rebase. It should be in the same coordinate system and have overlapping bounding boxes.</span>
<span class="sd">        :type base_raster: :class:`datasets.Raster`</span>
<span class="sd">        :param inplace: If True, the rebase operation will be performed in-place, and the original raster&#39;s grid will be modified. If False, a new rebased grid will be returned, and the original data will remain unchanged. Default is False.</span>
<span class="sd">        :type inplace: bool</span>
<span class="sd">        :param method: Interpolation method for rebasing the grid. Options include &quot;linear_model,&quot; &quot;nearest,&quot; and &quot;cubic.&quot; Default is &quot;linear_model.&quot;</span>
<span class="sd">        :type method: str</span>
<span class="sd">        :return: If inplace is False, a new rebased grid as a NumPy array. If inplace is True, returns None, and the original raster&#39;s grid is modified in-place.</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`` or None</span>

<span class="sd">        Notes</span>

<span class="sd">        - The rebase operation involves interpolating the values of the original grid to align with the reference raster&#39;s grid.</span>
<span class="sd">        - The method parameter specifies the interpolation method and can be &quot;linear_model,&quot; &quot;nearest,&quot; or &quot;cubic.&quot;</span>
<span class="sd">        - The rebase assumes that both rasters are in the same coordinate system and have overlapping bounding boxes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">griddata</span>

        <span class="c1"># get data points</span>
        <span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_grid_datapoints</span><span class="p">(</span><span class="n">drop_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># get base grid data points</span>
        <span class="n">_dfi</span> <span class="o">=</span> <span class="n">base_raster</span><span class="o">.</span><span class="n">get_grid_datapoints</span><span class="p">(</span><span class="n">drop_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># set data points</span>
        <span class="n">grd_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">grd_new_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_dfi</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">_dfi</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">_dfi</span><span class="p">[</span><span class="s2">&quot;zi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span>
            <span class="n">points</span><span class="o">=</span><span class="n">grd_points</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="n">grd_new_points</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span>
        <span class="p">)</span>
        <span class="n">grd_zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">_dfi</span><span class="p">[</span><span class="s2">&quot;zi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">newshape</span><span class="o">=</span><span class="n">base_raster</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="c1"># set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grd_zi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">base_raster</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="n">base_raster</span><span class="o">.</span><span class="n">prj</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">grd_zi</span></div>


<div class="viewcode-block" id="Raster.cut_edges">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.cut_edges">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cut_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cutoff upper and lower values of the raster grid.</span>

<span class="sd">        :param upper: The upper value for the cutoff.</span>
<span class="sd">        :type upper: float or int</span>
<span class="sd">        :param lower: The lower value for the cutoff.</span>
<span class="sd">        :type lower: float or int</span>
<span class="sd">        :param inplace: If True, modify the main grid in-place. If False, create a processed copy of the grid. Default is False.</span>
<span class="sd">        :type inplace: bool</span>
<span class="sd">        :return: The processed grid if inplace is False. If inplace is True, returns None.</span>
<span class="sd">        :rtype: Union[None, np.ndarray]</span>

<span class="sd">        **Notes**</span>
<span class="sd">        Values in the raster grid below the lower value are set to the lower value.</span>
<span class="sd">        Values in the raster grid above the upper value are set to the upper value.</span>
<span class="sd">        If inplace is False, a processed copy of the grid is returned, leaving the original grid unchanged.</span>
<span class="sd">        This function is useful for clipping extreme values in the raster grid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_grid</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">prune</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">upper</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">new_grid</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">new_grid</span></div>


    <span class="c1"># View internal methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster._plot">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster._plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a plot visualizing the Raster data.</span>

<span class="sd">        :param fig: The matplotlib figure object.</span>
<span class="sd">        :type fig: :class:`matplotlib.figure.Figure`</span>
<span class="sd">        :param gs: The matplotlib gridspec object for arranging subplots.</span>
<span class="sd">        :type gs: :class:`matplotlib.gridspec.GridSpec`</span>
<span class="sd">        :param specs: A dictionary containing plotting specifications and options.</span>
<span class="sd">        :type specs: dict</span>
<span class="sd">        :return: The modified matplotlib figure object with the plots.</span>
<span class="sd">        :rtype: :class:`matplotlib.figure.Figure`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># todo [DRY] most of this can be run on Univar -- make static method?</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mticker</span>

        <span class="c1"># from matplotlib.ticker import PercentFormatter  # Import PercentFormatter</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">formatter</span><span class="o">.</span><span class="n">set_scientific</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Ensure scientific notation is off</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_max</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="n">data_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">closest_max_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std_values</span><span class="p">)</span> <span class="o">-</span> <span class="n">data_max</span><span class="p">))</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">closest_max_index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">_id</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">std_values</span><span class="p">):</span>
                <span class="n">_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">std_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">std_values</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_plot_mean</span><span class="p">(</span><span class="n">axe</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">):</span>
            <span class="n">axe</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y_mu</span><span class="p">,</span>
                <span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span>
                <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">axe</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot; $\mu$ = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">y_mu</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_mu</span><span class="p">),</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># ------------- get aux data -------------</span>
        <span class="n">uni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_univar</span><span class="p">()</span>
        <span class="n">y_mu</span> <span class="o">=</span> <span class="n">uni</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">uni</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ylim</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">]</span>
        <span class="c1"># handle no range</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p_low</span> <span class="o">=</span> <span class="n">uni</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">uni</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;p01&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">p_hi</span> <span class="o">=</span> <span class="n">uni</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">uni</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;p99&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
                <span class="mi">0</span>
            <span class="p">]</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">p_hi</span> <span class="o">-</span> <span class="n">p_low</span>
            <span class="n">rng_margin</span> <span class="o">=</span> <span class="n">rng</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_low</span> <span class="o">-</span> <span class="n">rng_margin</span><span class="p">,</span> <span class="n">p_hi</span> <span class="o">+</span> <span class="n">rng_margin</span><span class="p">)</span>

        <span class="c1"># handle aux vars</span>
        <span class="n">plot_mean</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;plot_mean&quot;</span><span class="p">]</span>

        <span class="c1"># ------------ setup axes ------------</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">:</span><span class="mi">19</span><span class="p">])</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="mi">20</span><span class="p">:])</span>
        <span class="n">ax_cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span><span class="mi">13</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

        <span class="c1"># ------------ map plot ------------</span>
        <span class="c1"># handle zoom window</span>
        <span class="n">i_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">j_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">j_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i_min</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">][</span><span class="s2">&quot;i_min&quot;</span><span class="p">]</span>
            <span class="n">i_max</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">][</span><span class="s2">&quot;i_max&quot;</span><span class="p">]</span>
            <span class="n">j_min</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">][</span><span class="s2">&quot;j_min&quot;</span><span class="p">]</span>
            <span class="n">j_max</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">][</span><span class="s2">&quot;j_max&quot;</span><span class="p">]</span>
        <span class="n">grid_show</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i_min</span><span class="p">:</span><span class="n">i_max</span><span class="p">,</span> <span class="n">j_min</span><span class="p">:</span><span class="n">j_max</span><span class="p">]</span>
        <span class="n">grid_show_squared</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">make_square</span><span class="p">(</span><span class="n">grid_input</span><span class="o">=</span><span class="n">grid_show</span><span class="p">)</span>
        <span class="c1"># plot image</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">grid_show_squared</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="c1"># extent=self.get_extent(),</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_autoscale_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Prevent auto-scaling which might add padding</span>

        <span class="c1"># plot helper geometry</span>
        <span class="n">helper_geometry</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">helper_geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">helper_geometry</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_map&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_map&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="c1"># handle tick labels</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;grid_map&quot;</span><span class="p">]:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;grid_map&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
            <span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;neither&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_cbar</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Set the tick locations to only min and max</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

        <span class="c1"># Format the tick labels to display only these values</span>
        <span class="c1"># This custom formatter ensures only the set ticks are labeled</span>
        <span class="c1"># cbar.set_ticklabels(ylim)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_cbar</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="c1"># todo [DRY] -- this can be optimized since is the same plots in Univar._plot()</span>
        <span class="c1"># ------------ hist plot ------------</span>
        <span class="c1"># Standard x-axis maximum values for hist</span>
        <span class="n">sdmax1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">sdmax2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">standard_max_values</span> <span class="o">=</span> <span class="n">sdmax1</span> <span class="o">+</span> <span class="n">sdmax2</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">uni</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">uni</span><span class="o">.</span><span class="n">varfield</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;bins&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;color_hist&quot;</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_hist&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_hist&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="c1"># Get the maximum value from the data</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">_get_max</span><span class="p">(</span><span class="n">standard_max_values</span><span class="p">,</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.1</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ylabel&quot;</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="c1"># extra lines</span>
        <span class="k">if</span> <span class="n">plot_mean</span><span class="p">:</span>
            <span class="n">_plot_mean</span><span class="p">(</span>
                <span class="n">ax2</span><span class="p">,</span>
                <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># ------------ CDF plot ------------</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">uni</span><span class="o">.</span><span class="n">weibull_df</span><span class="p">[</span><span class="s2">&quot;P(X)&quot;</span><span class="p">],</span> <span class="n">uni</span><span class="o">.</span><span class="n">weibull_df</span><span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;color_cdf&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_cdf&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_cdf&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xlabel_cdf&quot;</span><span class="p">])</span>
        <span class="c1"># ax3.set_xticklabels([0, 0.5, 1.0])</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>

        <span class="c1"># extra lines</span>
        <span class="k">if</span> <span class="n">plot_mean</span><span class="p">:</span>
            <span class="n">_plot_mean</span><span class="p">(</span>
                <span class="n">ax3</span><span class="p">,</span>
                <span class="n">xmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="n">xmax</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">Univar</span><span class="o">.</span><span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">stats_df</span><span class="o">=</span><span class="n">uni</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">plot_metadata</span><span class="p">(</span>
            <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="Raster._set_view_specs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster._set_view_specs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_view_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set default view specs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span>
        <span class="c1"># borrow from Univar</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">GeoUnivar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">uv</span><span class="o">.</span><span class="n">view_specs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> | </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="s2">&quot;run_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;zoom_window&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;subtitle_map&quot;</span><span class="p">:</span> <span class="s2">&quot;2D distribution&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;ylabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;grid_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># View methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster.view">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.view">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">helper_geometry</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays or returns a visualization of the spatial data.</span>

<span class="sd">        :param show: If True, the plot is displayed. Default value = True</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param return_fig: If True, the matplotlib figure object is returned. Default value = False</span>
<span class="sd">        :type return_fig: bool</span>
<span class="sd">        :param helper_geometry: [optional] An optional geometry object to overlay on the map.</span>
<span class="sd">        :type helper_geometry: object</span>
<span class="sd">        :return: The matplotlib figure object if `return_fig` is True, otherwise None.</span>
<span class="sd">        :rtype: :class:`matplotlib.figure.Figure` or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle specs</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">specs_aux</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
            <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">FIG_SIZES</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="s2">&quot;w&quot;</span><span class="p">],</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">FIG_SIZES</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="s2">&quot;h&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="c1"># update</span>
        <span class="n">specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">specs_aux</span><span class="p">)</span>
        <span class="c1"># update gridspecs</span>
        <span class="n">specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">GRID_SPECS</span><span class="p">)</span>
        <span class="c1"># update geometry</span>
        <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">helper_geometry</span>

        <span class="c1"># -------------- BUILD --------------</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">build_fig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>

        <span class="c1"># -------------- PLOT --------------</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="o">=</span><span class="n">gs</span><span class="p">,</span> <span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>

        <span class="c1"># -------------- SHIP --------------</span>
        <span class="c1"># plt.tight_layout()</span>
        <span class="c1"># create path</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;fig_format&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">viewer</span><span class="o">.</span><span class="n">ship_fig</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">file_output</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">])</span></div>


    <span class="c1"># Static methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>

<div class="viewcode-block" id="Raster.plot_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.plot_metadata">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_metadata</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds raster metadata as text annotations to a matplotlib figure.</span>

<span class="sd">        :param fig: The matplotlib figure object to which metadata will be added.</span>
<span class="sd">        :type fig: :class:`matplotlib.figure.Figure`</span>
<span class="sd">        :param metadata: A dictionary containing raster metadata (e.g., &#39;nrows&#39;, &#39;ncols&#39;, &#39;cellsize&#39;, &#39;xllcorner&#39;, &#39;yllcorner&#39;, &#39;NODATA_value&#39;).</span>
<span class="sd">        :type metadata: dict</span>
<span class="sd">        :param x: The x-coordinate (figure fraction) for the left-most column of metadata. Default value = 0.0</span>
<span class="sd">        :type x: float</span>
<span class="sd">        :param y: The y-coordinate (figure fraction) for the top row of metadata. Default value = 0.1</span>
<span class="sd">        :type y: float</span>
<span class="sd">        :return: The modified matplotlib figure object.</span>
<span class="sd">        :rtype: :class:`matplotlib.figure.Figure`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_plot_column</span><span class="p">(</span><span class="n">x_position</span><span class="p">,</span> <span class="n">ls_meta</span><span class="p">,</span> <span class="n">start_y</span><span class="p">):</span>
            <span class="n">current_y</span> <span class="o">=</span> <span class="n">start_y</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ls_meta</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x_position</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">current_y</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                    <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;monospace&quot;</span><span class="p">},</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">current_y</span> <span class="o">-=</span> <span class="n">n_step</span>

        <span class="n">n_step</span> <span class="o">=</span> <span class="mf">0.03</span>

        <span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&gt;10}</span><span class="s2">: </span><span class="si">{:&lt;10}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Rows&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;nrows&quot;</span><span class="p">])</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&gt;10}</span><span class="s2">: </span><span class="si">{:&lt;10}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Cols&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ncols&quot;</span><span class="p">])</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&gt;10}</span><span class="s2">: </span><span class="si">{:&lt;10.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Cell&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;cellsize&quot;</span><span class="p">])</span>
        <span class="n">ls_meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">]</span>
        <span class="n">_plot_column</span><span class="p">(</span><span class="n">x_position</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">ls_meta</span><span class="o">=</span><span class="n">ls_meta</span><span class="p">,</span> <span class="n">start_y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>

        <span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&gt;10}</span><span class="s2">: </span><span class="si">{:&lt;10.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;XLL&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;xllcorner&quot;</span><span class="p">])</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&gt;10}</span><span class="s2">: </span><span class="si">{:&lt;10.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;YLL&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;yllcorner&quot;</span><span class="p">])</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&gt;10}</span><span class="s2">: </span><span class="si">{:&lt;10.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;NaN&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">])</span>
        <span class="n">ls_meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">]</span>
        <span class="n">_plot_column</span><span class="p">(</span><span class="n">x_position</span><span class="o">=</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">ls_meta</span><span class="o">=</span><span class="n">ls_meta</span><span class="p">,</span> <span class="n">start_y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="Raster.read_tif_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.read_tif_metadata">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_tif_metadata</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">n_band</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read raster metadata from a file.</span>

<span class="sd">        :param file_input: Path to the input raster file.</span>
<span class="sd">        :type file_input: str</span>
<span class="sd">        :param n_band: [optional] Band number to read. Default value = 1</span>
<span class="sd">        :type n_band: int</span>
<span class="sd">        :return: Dictionary containing raster metadata.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raster_input</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">)</span>
        <span class="n">dc_metatada</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="n">raster_input</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="n">raster_input</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="s2">&quot;xllcorner&quot;</span><span class="p">:</span> <span class="n">raster_input</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">left</span><span class="p">,</span>
            <span class="s2">&quot;yllcorner&quot;</span><span class="p">:</span> <span class="n">raster_input</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span>
            <span class="s2">&quot;cellsize&quot;</span><span class="p">:</span> <span class="n">raster_input</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;NODATA_value&quot;</span><span class="p">:</span> <span class="n">raster_input</span><span class="o">.</span><span class="n">nodata</span><span class="p">,</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">raster_input</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">raster_input</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">raster_input</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dc_metatada</span></div>


<div class="viewcode-block" id="Raster.read_tif">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.read_tif">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_tif</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a raster band from a file.</span>

<span class="sd">        :param file_input: Path to the input raster file.</span>
<span class="sd">        :type file_input: str</span>
<span class="sd">        :param dtype: Data type for the output grid. Default value = &quot;float&quot;</span>
<span class="sd">        :type dtype: str</span>
<span class="sd">        :param id_band: Band id to read. Default value = 1</span>
<span class="sd">        :type id_band: int</span>
<span class="sd">        :param metadata: Whether to include metadata in the output dictionary. Default value = True</span>
<span class="sd">        :type metadata: bool</span>
<span class="sd">        :return: Dictionary containing the raster grid and optionally its metadata.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raster_input</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">)</span>
        <span class="n">grid_input</span> <span class="o">=</span> <span class="n">raster_input</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">id_band</span><span class="p">)</span>
        <span class="n">dc_raster</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">grid_input</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">dc_metadata</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">read_tif_metadata</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">id_band</span><span class="p">)</span>
            <span class="n">dc_raster</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc_metadata</span>
        <span class="n">raster_input</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dc_raster</span></div>


<div class="viewcode-block" id="Raster.write_tif">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.write_tif">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_tif</span><span class="p">(</span>
        <span class="n">grid_output</span><span class="p">,</span> <span class="n">dc_metadata</span><span class="p">,</span> <span class="n">file_output</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">n_bands</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a raster band to a file.</span>

<span class="sd">        :param grid_output: The grid data to write.</span>
<span class="sd">        :type grid_output: :class:`numpy.ndarray`</span>
<span class="sd">        :param dc_metadata: Dictionary containing the raster metadata.</span>
<span class="sd">        :type dc_metadata: dict</span>
<span class="sd">        :param file_output: Path to the output raster file.</span>
<span class="sd">        :type file_output: str</span>
<span class="sd">        :param dtype: Data type alias for the output grid (numpy standard). Default value = &quot;float32&quot;</span>
<span class="sd">        :type dtype: str</span>
<span class="sd">        :param n_bands: Number of bands in the output raster. Default value = 1</span>
<span class="sd">        :type n_bands: int</span>
<span class="sd">        :param id_band: Band ID to write the data to. Default value = 1</span>
<span class="sd">        :type id_band: int</span>
<span class="sd">        :return: Path to the output raster file. (echo)</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define the profile for the new GeoTIFF</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">dc_metadata</span><span class="p">[</span><span class="s2">&quot;nrows&quot;</span><span class="p">],</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">dc_metadata</span><span class="p">[</span><span class="s2">&quot;ncols&quot;</span><span class="p">],</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">n_bands</span><span class="p">,</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">dtype</span><span class="p">,</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">dc_metadata</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">],</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">dc_metadata</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">],</span>
            <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="n">dc_metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">],</span>
            <span class="s2">&quot;compress&quot;</span><span class="p">:</span> <span class="s2">&quot;lzw&quot;</span><span class="p">,</span>  <span class="c1"># Using LZW compression</span>
        <span class="p">}</span>
        <span class="c1"># write</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">grid_output</span><span class="p">,</span> <span class="n">id_band</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_output</span></div>


<div class="viewcode-block" id="Raster.read_asc_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.read_asc_metadata">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_asc_metadata</span><span class="p">(</span><span class="n">file_input</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads metadata from an ASCII raster file.</span>

<span class="sd">        :param file_input: Path to the input ASCII file.</span>
<span class="sd">        :type file_input: str</span>
<span class="sd">        :return: A dictionary containing the metadata.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">def_lst</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">def_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># append each line to the list</span>
        <span class="c1">#</span>
        <span class="c1"># get metadata constructor loop</span>
        <span class="n">meta_lbls</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ncols&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nrows&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xllcorner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yllcorner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cellsize&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NODATA_value&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">meta_format</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">dc_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">lcl_lst</span> <span class="o">=</span> <span class="n">def_lst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">lcl_meta_str</span> <span class="o">=</span> <span class="n">lcl_lst</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lcl_lst</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">meta_format</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
                <span class="n">dc_metadata</span><span class="p">[</span><span class="n">meta_lbls</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lcl_meta_str</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dc_metadata</span><span class="p">[</span><span class="n">meta_lbls</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lcl_meta_str</span><span class="p">)</span>
        <span class="c1"># append missing params</span>
        <span class="n">dc_metadata</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dc_metadata</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">dc_metadata</span></div>


<div class="viewcode-block" id="Raster.read_asc">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.read_asc">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_asc</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads an ASCII raster file into a dictionary.</span>

<span class="sd">        :param file_input: Path to the input ASCII file.</span>
<span class="sd">        :type file_input: str</span>
<span class="sd">        :param dtype: Data type for the raster data. Default value = &quot;float32&quot;</span>
<span class="sd">        :type dtype: str</span>
<span class="sd">        :param metadata: Whether to read and include metadata from the ASCII file. Default value = True</span>
<span class="sd">        :type metadata: bool</span>
<span class="sd">        :return: A dictionary containing the raster data and optionally its metadata.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_file</span><span class="p">:</span>
            <span class="n">lst_file</span> <span class="o">=</span> <span class="n">f_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="c1"># Grid construction using numpy</span>
        <span class="n">grd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">lst_file</span><span class="p">[</span><span class="mi">6</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">dc_raster</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">grd_data</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">dc_raster</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">read_asc_metadata</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_input</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dc_raster</span></div>


<div class="viewcode-block" id="Raster.write_asc">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.write_asc">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_asc</span><span class="p">(</span><span class="n">grid_output</span><span class="p">,</span> <span class="n">dc_metadata</span><span class="p">,</span> <span class="n">file_output</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a raster grid and its metadata to an ASCII file.</span>

<span class="sd">        :param grid_output: The raster data to write.</span>
<span class="sd">        :type grid_output: :class:`numpy.ndarray`</span>
<span class="sd">        :param dc_metadata: Dictionary containing the metadata for the ASCII file.</span>
<span class="sd">        :type dc_metadata: dict</span>
<span class="sd">        :param file_output: Path for the output ASCII file.</span>
<span class="sd">        :type file_output: str</span>
<span class="sd">        :param dtype: Data type for the raster data in the output file. Default value = &quot;float32&quot;</span>
<span class="sd">        :type dtype: str</span>
<span class="sd">        :return: The path of the generated output ASCII file.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># metadata construct heading</span>
        <span class="n">meta_lbls</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;ncols&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nrows&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xllcorner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yllcorner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cellsize&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NODATA_value&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ndv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dc_metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">])</span>
        <span class="n">exp_lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">meta_lbls</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">    </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta_lbls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dc_metadata</span><span class="p">[</span><span class="n">meta_lbls</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">exp_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># ----------------------------------</span>
        <span class="c1"># data constructor loop:</span>
        <span class="n">grid_output_fix</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">apply_nodata</span><span class="p">(</span>
            <span class="n">grid_input</span><span class="o">=</span><span class="n">grid_output</span><span class="p">,</span> <span class="n">nodatavalue</span><span class="o">=</span><span class="n">ndv</span>
        <span class="p">)</span>  <span class="c1"># insert nodatavalue</span>
        <span class="c1"># force dtype</span>
        <span class="n">grid_output_fix2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">grid_output_fix</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_output_fix2</span><span class="p">)):</span>
            <span class="c1"># replace np.nan to no data values</span>
            <span class="n">lcl_row_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">grid_output_fix2</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lcl_row_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># print(&#39;Yeas&#39;)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_output_fix2</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">grid_output_fix2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]):</span>
                        <span class="n">grid_output_fix2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ndv</span><span class="p">)</span>
            <span class="n">str_join</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grid_output_fix2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">exp_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str_join</span><span class="p">)</span>

        <span class="n">fle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_output</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
        <span class="n">fle</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">exp_lst</span><span class="p">)</span>
        <span class="n">fle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">file_output</span></div>


<div class="viewcode-block" id="Raster.apply_nodata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.apply_nodata">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_nodata</span><span class="p">(</span><span class="n">grid_input</span><span class="p">,</span> <span class="n">nodatavalue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a nodata value to the input grid.</span>

<span class="sd">        :param grid_input: The input grid.</span>
<span class="sd">        :type grid_input: :class:`numpy.ndarray`</span>
<span class="sd">        :param nodatavalue: [optional] The nodata value to apply. Default value = None</span>
<span class="sd">        :type nodatavalue: int or float</span>
<span class="sd">        :return: The grid with the nodata value applied.</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nodatavalue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">grid_input</span>  <span class="c1"># Return original grid if no nodatavalue is provided</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grid_input</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">]:</span>
                <span class="c1"># for integer grid</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">grid_input</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">nodatavalue</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for floating point grid:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">grid_input</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="n">nodatavalue</span><span class="p">)</span></div>


<div class="viewcode-block" id="Raster.make_square">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Raster.make_square">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_square</span><span class="p">(</span><span class="n">grid_input</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reshapes a 2D input grid into a square array, padding with NaNs or masked values if necessary.</span>

<span class="sd">        :param grid_input: The input 2D array (grid).</span>
<span class="sd">        :type grid_input: :class:`numpy.ndarray`</span>
<span class="sd">        :return: A square array containing the original grid, padded with NaNs or masked values.</span>
<span class="sd">        :rtype: :class:`numpy.ndarray`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the size for the squared array</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">grid_input</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid_input</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">]:</span>
            <span class="c1"># for integer grid</span>
            <span class="n">squared_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># for floating point grid:</span>
            <span class="c1"># Create a new array filled with NaN</span>
            <span class="n">squared_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="c1"># Place the original array (with masked values converted to NaN) in the upper left corner</span>
        <span class="n">squared_arr</span><span class="p">[:</span> <span class="n">grid_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span> <span class="n">grid_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">grid_input</span>
        <span class="k">return</span> <span class="n">squared_arr</span></div>
</div>



<div class="viewcode-block" id="SciRaster">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.SciRaster">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SciRaster</span><span class="p">(</span><span class="n">Raster</span><span class="p">):</span>
    <span class="c1"># todo [major docstring improvements]</span>

<div class="viewcode-block" id="SciRaster.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.SciRaster.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MySciRaster&quot;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># add new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_default</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodata_default</span> <span class="o">=</span> <span class="n">DC_NODATA</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite_nodata</span><span class="p">()</span></div>


<div class="viewcode-block" id="SciRaster._set_view_specs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.SciRaster._set_view_specs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_view_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_default</span></div>


<div class="viewcode-block" id="SciRaster._overwrite_nodata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.SciRaster._overwrite_nodata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_overwrite_nodata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_default</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SciRaster.set_raster_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.SciRaster.set_raster_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_raster_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite_nodata</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="QualiRaster">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QualiRaster</span><span class="p">(</span><span class="n">Raster</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic qualitative raster map dataset.</span>
<span class="sd">    todo [docstring] -- examples</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Dunder methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="QualiRaster.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;QualiMap&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">):</span>
        <span class="c1"># prior setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_csvfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># call superior</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1"># overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;tab20&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;Unknown variable&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span> <span class="o">=</span> <span class="s2">&quot;Var&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;category ID&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_csvfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodata_default</span> <span class="o">=</span> <span class="n">DC_NODATA</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite_nodata</span><span class="p">()</span></div>

        <span class="c1"># NOTE: view specs is set by setting table</span>

    <span class="c1"># Dunder methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="QualiRaster._set_fields">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster._set_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ------------ call super ----------- #</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_fields</span><span class="p">()</span>
        <span class="c1"># Attribute fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_id</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_area</span> <span class="o">=</span> <span class="s2">&quot;area&quot;</span></div>

        <span class="c1"># ... continues in downstream objects ... #</span>

<div class="viewcode-block" id="QualiRaster._overwrite_nodata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster._overwrite_nodata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_overwrite_nodata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodata_default</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># Get methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="QualiRaster.get_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.get_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all metadata from base_object</span>

<span class="sd">        :return: metadata</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_dict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;Path_CSV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_csvfile</span>
        <span class="k">return</span> <span class="n">_dict</span></div>


<div class="viewcode-block" id="QualiRaster.get_areas">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.get_areas">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_areas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get areas in map of each category in table.</span>

<span class="sd">        :param inplace: option to merge data with raster table</span>
<span class="sd">        :type inplace: bool, defaults to False</span>
<span class="sd">        :return: areas dataframe</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get unit area in meters</span>
            <span class="n">_cell_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">linear_units</span> <span class="o">==</span> <span class="s2">&quot;degree&quot;</span><span class="p">:</span>
                <span class="n">_cell_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span> <span class="o">*</span> <span class="mi">111111</span>  <span class="c1"># convert degrees to meters</span>
            <span class="n">_n_unit_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">_cell_size</span><span class="p">)</span>
            <span class="c1"># get aux dataframe</span>
            <span class="n">df_aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_alias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_color</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">_lst_count</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># iterate categories</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_aux</span><span class="p">)):</span>
                <span class="n">_n_id</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">_n_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">_n_id</span><span class="p">))</span>
                <span class="n">_lst_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_n_count</span><span class="p">)</span>
            <span class="c1"># set area fields</span>
            <span class="n">lst_area_fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Count</span>
            <span class="n">s_count_field</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">s_count_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">_lst_count</span>
            <span class="n">lst_area_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_count_field</span><span class="p">)</span>

            <span class="c1"># m2</span>
            <span class="n">s_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_m2&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="p">)</span>
            <span class="n">lst_area_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_field</span><span class="p">)</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">s_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">s_count_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">_n_unit_area</span>

            <span class="c1"># ha</span>
            <span class="n">s_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_ha&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="p">)</span>
            <span class="n">lst_area_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_field</span><span class="p">)</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">s_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">s_count_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">_n_unit_area</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

            <span class="c1"># km2</span>
            <span class="n">s_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_km2&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="p">)</span>
            <span class="n">lst_area_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_field</span><span class="p">)</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">s_field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df_aux</span><span class="p">[</span><span class="n">s_count_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">_n_unit_area</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># fraction</span>
            <span class="n">s_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_f&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="p">)</span>
            <span class="n">lst_area_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_field</span><span class="p">)</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">s_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">s_count_field</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">s_count_field</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="c1"># %</span>
            <span class="n">s_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="p">)</span>
            <span class="n">lst_area_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_field</span><span class="p">)</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">s_field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">s_count_field</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">s_count_field</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="c1"># handle merge</span>
            <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lst_area_fields</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">df_aux</span></div>


<div class="viewcode-block" id="QualiRaster.get_zonal_stats">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.get_zonal_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_zonal_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raster_sample</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get zonal stats from other raster map to sample.</span>

<span class="sd">        :param raster_sample: raster map to sample</span>
<span class="sd">        :type raster_sample: :class:`datasets.Raster`</span>
<span class="sd">        :param merge: option to merge data with raster table, defaults to False</span>
<span class="sd">        :type merge: bool</span>
<span class="sd">        :param skip_count: set True to skip count, defaults to False</span>
<span class="sd">        :type skip_count: bool</span>
<span class="sd">        :return: dataframe of zonal stats</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">plans.analyst</span><span class="w"> </span><span class="kn">import</span> <span class="n">Univar</span>

        <span class="c1"># deploy dataframe</span>
        <span class="n">df_aux1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_table</span><span class="p">()</span>  <span class="c1"># clean</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># get copy</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_alias</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_table</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">df_aux1</span><span class="p">)</span>  <span class="c1"># restore uncleaned table</span>

        <span class="c1"># store copy of raster</span>
        <span class="n">grid_raster</span> <span class="o">=</span> <span class="n">raster_sample</span><span class="o">.</span><span class="n">data</span>
        <span class="n">varname</span> <span class="o">=</span> <span class="n">raster_sample</span><span class="o">.</span><span class="n">varname</span>
        <span class="c1"># collect statistics</span>
        <span class="n">lst_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_aux</span><span class="p">)):</span>
            <span class="n">n_id</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># apply mask</span>
            <span class="n">grid_aoi</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">n_id</span><span class="p">)</span>
            <span class="n">raster_sample</span><span class="o">.</span><span class="n">apply_aoi_mask</span><span class="p">(</span><span class="n">grid_aoi</span><span class="o">=</span><span class="n">grid_aoi</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># get basic stats</span>
            <span class="n">raster_uni</span> <span class="o">=</span> <span class="n">Univar</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">raster_sample</span><span class="o">.</span><span class="n">get_grid_data</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">varname</span><span class="p">)</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">raster_uni</span><span class="o">.</span><span class="n">assess_basic_stats</span><span class="p">()</span>
            <span class="n">lst_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="c1"># restore</span>
            <span class="n">raster_sample</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">grid_raster</span>

        <span class="c1"># create empty fields</span>
        <span class="n">lst_stats_field</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_stats</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]:</span>
            <span class="n">s_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">lst_stats_field</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_field</span><span class="p">)</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">s_field</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># fill values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_aux</span><span class="p">)):</span>
            <span class="n">df_aux</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">lst_stats_field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">lst_stats_field</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">lst_stats</span><span class="p">[</span><span class="n">i</span><span class="p">][</span>
                <span class="s2">&quot;value&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># handle count</span>
        <span class="k">if</span> <span class="n">skip_count</span><span class="p">:</span>
            <span class="n">df_aux</span> <span class="o">=</span> <span class="n">df_aux</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_count&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">)])</span>
            <span class="n">lst_stats_field</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_count&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">))</span>

        <span class="c1"># handle merge</span>
        <span class="k">if</span> <span class="n">merge</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lst_stats_field</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">return</span> <span class="n">df_aux</span></div>


<div class="viewcode-block" id="QualiRaster.get_aoi">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.get_aoi">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_aoi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by_value_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the AOI map from a specific value id (value is expected to exist in the raster)</span>
<span class="sd">        :param by_value_id: category id value</span>
<span class="sd">        :type by_value_id: int</span>
<span class="sd">        :return: AOI map</span>
<span class="sd">        :rtype: :class:`AOI`` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">plans.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">AOI</span>

        <span class="n">map_aoi</span> <span class="o">=</span> <span class="n">AOI</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span> <span class="n">by_value_id</span><span class="p">))</span>
        <span class="n">map_aoi</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">)</span>
        <span class="n">map_aoi</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prj</span>
        <span class="c1"># set grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_nodata</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">by_value_id</span><span class="p">:</span>
            <span class="n">map_aoi</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">by_value_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">map_aoi</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodatavalue</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_nodata</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">map_aoi</span></div>


    <span class="c1"># Set methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="QualiRaster.set_random_colors">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.set_random_colors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_random_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set random colors to attribute table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_color</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_colors</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span>
            <span class="p">)</span>
            <span class="c1"># reaload table for reset viewspecs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_table</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRaster.set_raster_metadata">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.set_raster_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_raster_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite_nodata</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRaster.set_table">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.set_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set attributes dataframe from incoming :class:`pandas.DataFrame`.</span>

<span class="sd">        :param dataframe: incoming pandas dataframe</span>
<span class="sd">        :type dataframe: :class:`pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">dataframe_prepro</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
        <span class="c1"># set view specs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># Data methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="QualiRaster.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">file_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_prj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data from files to the raster object.</span>

<span class="sd">        :param file_data: The path to the raster file.</span>
<span class="sd">        :type file_data: str</span>
<span class="sd">        :param file_table: path to table file</span>
<span class="sd">        :type file_table: str</span>
<span class="sd">        :param file_prj: The path to the &#39;.prj&#39; projection file. If not provided, an attempt is made to use the same path and name as the ``.asc`` file with the &#39;.prj&#39; extension.</span>
<span class="sd">        :type file_prj: str</span>
<span class="sd">        :param id_band: Band id to read for GeoTIFF. Default value = 1</span>
<span class="sd">        :type id_band: int</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">file_data</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span> <span class="n">file_prj</span><span class="o">=</span><span class="n">file_prj</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="n">id_band</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite_nodata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_nodata</span><span class="p">(</span><span class="n">new_nodata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodata_default</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_table</span><span class="p">(</span><span class="n">file_table</span><span class="o">=</span><span class="n">file_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRaster.load_table">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.load_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load attributes dataframe from table file.</span>

<span class="sd">        :param file_table: path to to file</span>
<span class="sd">        :type file_table: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_csvfile</span> <span class="o">=</span> <span class="n">file_table</span>
        <span class="c1"># read raw file</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_table</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="c1"># set to self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_table</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">df_aux</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRaster.export">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.export">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export raster sample</span>

<span class="sd">        :param folder: path to folder,</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: string of file without extension, defaults to None</span>
<span class="sd">        :type filename: str</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_table</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRaster.export_table">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.export_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export table file.</span>

<span class="sd">        :param folder: path to folde</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: string of file without extension</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: full file name (path to and extension) string</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">flenm</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_csv_ext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">flenm</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_csv_sep</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flenm</span></div>


<div class="viewcode-block" id="QualiRaster.clear_table">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.clear_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the unfound values in the map from the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># found values:</span>
            <span class="n">lst_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># filter dataframe</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">lst_ids</span><span class="p">)]</span>
            <span class="c1"># reset table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_table</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">filtered_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRaster.rebase_grid">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.rebase_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rebase_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_raster</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method calls the `rebase_grid` method of the superclass to perform</span>
<span class="sd">        the grid rebasement using the &quot;nearest&quot; interpolation method.</span>

<span class="sd">        :param base_raster: The raster object to rebase against.</span>
<span class="sd">        :type base_raster: :class:`Raster`</span>
<span class="sd">        :param inplace: If True, the operation is performed in-place. Default value = False</span>
<span class="sd">        :type inplace: bool</span>
<span class="sd">        :return: The rebased object.</span>
<span class="sd">        :rtype: :class:`Raster`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rebase_grid</span><span class="p">(</span><span class="n">base_raster</span><span class="p">,</span> <span class="n">inplace</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="QualiRaster.reclassify">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.reclassify">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reclassify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_ids</span><span class="p">,</span> <span class="n">df_new_table</span><span class="p">,</span> <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reclassify QualiRaster Ids in grid and table</span>

<span class="sd">        :param dict_ids: dictionary to map from &quot;Old_Id&quot; to &quot;New_id&quot;</span>
<span class="sd">        :type dict_ids: dict</span>
<span class="sd">        :param df_new_table: new table for QualiRaster</span>
<span class="sd">        :type df_new_table: :class:`pandas.DataFrame`</span>
<span class="sd">        :param talk: option for printing messages</span>
<span class="sd">        :type talk: bool</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grid_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dict_ids</span><span class="p">[</span><span class="s2">&quot;Old_Id&quot;</span><span class="p">])):</span>
            <span class="n">n_old_id</span> <span class="o">=</span> <span class="n">dict_ids</span><span class="p">[</span><span class="s2">&quot;Old_Id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">n_new_id</span> <span class="o">=</span> <span class="n">dict_ids</span><span class="p">[</span><span class="s2">&quot;New_Id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">talk</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt; reclassify Ids from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_old_id</span><span class="p">,</span> <span class="n">n_new_id</span><span class="p">))</span>
            <span class="n">grid_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid_new</span> <span class="o">*</span> <span class="p">(</span><span class="n">grid_new</span> <span class="o">!=</span> <span class="n">n_old_id</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">n_new_id</span> <span class="o">*</span> <span class="p">(</span><span class="n">grid_new</span> <span class="o">==</span> <span class="n">n_old_id</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># set new grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid_new</span><span class="p">)</span>
        <span class="c1"># reset table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_table</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">df_new_table</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRaster.apply_values">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.apply_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_field</span><span class="p">):</span>
        <span class="n">new_grid</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
            <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">old_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">new_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">table_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">new_grid</span></div>


    <span class="c1"># View methods</span>
    <span class="c1"># -------------------------------------------------------------------</span>
<div class="viewcode-block" id="QualiRaster._plot">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster._plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">specs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a plot visualizing the spatial data and its area distribution.</span>

<span class="sd">        This method creates a figure with a map of the spatial data and a horizontal bar chart</span>
<span class="sd">        showing the percentage area of each unique class. It can aggregate smaller classes</span>
<span class="sd">        into an &quot;others&quot; category and displays raster metadata.</span>

<span class="sd">        :param fig: The matplotlib figure object.</span>
<span class="sd">        :type fig: :class:`matplotlib.figure.Figure`</span>
<span class="sd">        :param gs: The matplotlib gridspec object for arranging subplots.</span>
<span class="sd">        :type gs: :class:`matplotlib.gridspec.GridSpec`</span>
<span class="sd">        :param specs: A dictionary containing plotting specifications and options.</span>
<span class="sd">        :type specs: dict</span>
<span class="sd">        :return: The modified matplotlib figure object with the plots.</span>
<span class="sd">        :rtype: :class:`matplotlib.figure.Figure`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># todo [DRY] most of this can be run on Univar -- make static method?</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mticker</span>

        <span class="c1"># from matplotlib.ticker import PercentFormatter  # Import PercentFormatter</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">formatter</span><span class="o">.</span><span class="n">set_scientific</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Ensure scientific notation is off</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_max</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="n">data_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">closest_max_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std_values</span><span class="p">)</span> <span class="o">-</span> <span class="n">data_max</span><span class="p">))</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">closest_max_index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">_id</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">std_values</span><span class="p">):</span>
                <span class="n">_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">std_values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">std_values</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_plot_mean</span><span class="p">(</span><span class="n">axe</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">):</span>
            <span class="n">axe</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y_mu</span><span class="p">,</span>
                <span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span>
                <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">axe</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot; $\mu$ = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">y_mu</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y_mu</span><span class="p">),</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_categorize_and_limit</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Sorts a DataFrame by &#39;count&#39; and aggregates rows beyond a limit M into an &#39;others&#39; category.</span>
<span class="sd">            It now expects &#39;id&#39; instead of &#39;class&#39; and &#39;name&#39; instead of &#39;category&#39;.</span>
<span class="sd">            Includes &#39;color&#39; and &#39;alias&#39; fields, with specific values for the &#39;others&#39; category.</span>

<span class="sd">            Args:</span>
<span class="sd">                df (pd.DataFrame): The input DataFrame with &#39;id&#39;, &#39;name&#39;, &#39;count&#39;, &#39;color&#39;, and &#39;alias&#39; columns.</span>
<span class="sd">                M (int): The number of top rows to keep.</span>

<span class="sd">            Returns:</span>
<span class="sd">                pd.DataFrame: A new DataFrame with the top M rows and an aggregated &#39;others&#39; row.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Sort the DataFrame by &#39;count&#39; in descending order</span>
            <span class="n">df_sorted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Select the top M rows</span>
            <span class="n">df_top_M</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

            <span class="c1"># Aggregate the remaining rows into an &#39;others&#39; category</span>
            <span class="n">df_others</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                <span class="n">M</span><span class="p">:</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># .copy() to avoid SettingWithCopyWarning</span>

            <span class="c1"># Create a dictionary for the &#39;others&#39; aggregated row</span>
            <span class="n">agg_field1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="si">}</span><span class="s2">_f&quot;</span>
            <span class="n">agg_field2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="si">}</span><span class="s2">_ha&quot;</span>
            <span class="n">agg_field3</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="si">}</span><span class="s2">_km2&quot;</span>
            <span class="n">agg_field4</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="si">}</span><span class="s2">_m2&quot;</span>
            <span class="n">agg_field5</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="si">}</span><span class="s2">_%&quot;</span>
            <span class="n">agg_field6</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>

            <span class="n">others_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">:</span> <span class="s2">&quot;others&quot;</span><span class="p">,</span>  <span class="c1"># &#39;name&#39; instead of &#39;category&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_alias</span><span class="p">:</span> <span class="s2">&quot;Etc&quot;</span><span class="p">,</span>  <span class="c1"># Specific alias for &#39;others&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_color</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>  <span class="c1"># Specific color for &#39;others&#39;</span>
                <span class="n">agg_field1</span><span class="p">:</span> <span class="n">df_others</span><span class="p">[</span><span class="n">agg_field1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">agg_field2</span><span class="p">:</span> <span class="n">df_others</span><span class="p">[</span><span class="n">agg_field2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">agg_field3</span><span class="p">:</span> <span class="n">df_others</span><span class="p">[</span><span class="n">agg_field3</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">agg_field4</span><span class="p">:</span> <span class="n">df_others</span><span class="p">[</span><span class="n">agg_field4</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">agg_field5</span><span class="p">:</span> <span class="n">df_others</span><span class="p">[</span><span class="n">agg_field5</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">agg_field6</span><span class="p">:</span> <span class="n">df_others</span><span class="p">[</span><span class="n">agg_field6</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="c1"># Convert the dictionary to a DataFrame row</span>
            <span class="n">df_others_aggregated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">others_data</span><span class="p">])</span>

            <span class="c1"># Concatenate the top M rows with the &#39;others&#39; category</span>
            <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_top_M</span><span class="p">,</span> <span class="n">df_others_aggregated</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">df_final</span>

        <span class="n">ylim</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">]</span>

        <span class="c1"># ---------- preable ---------</span>
        <span class="n">df_areas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_areas</span><span class="p">()</span>

        <span class="c1"># cut off zeros</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;cutoff&quot;</span><span class="p">]:</span>
            <span class="n">df_areas</span> <span class="o">=</span> <span class="n">df_areas</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;count &gt; 0&quot;</span><span class="p">)</span>

        <span class="n">total_area</span> <span class="o">=</span> <span class="n">df_areas</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="p">,</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;area_unit&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">n_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_areas</span><span class="p">)</span>
        <span class="n">n_max</span> <span class="o">=</span> <span class="mi">14</span>

        <span class="c1"># handle variations</span>
        <span class="k">if</span> <span class="n">n_len</span> <span class="o">&gt;=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;max_classes&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">df_areas</span> <span class="o">=</span> <span class="n">_categorize_and_limit</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_areas</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;max_classes&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">n_len</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">n_len</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">n_max</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="n">n_len</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">n_max</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="c1"># setup dataframe</span>
        <span class="n">df_areas</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_areas</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># print(df_areas.to_string())</span>

        <span class="c1"># ------------ setup axes ------------</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span>

        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">n_max</span><span class="p">,</span> <span class="mi">18</span><span class="p">:</span><span class="mi">23</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

        <span class="c1"># ------------ map plot ------------</span>
        <span class="c1"># handle zoom window</span>
        <span class="n">i_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">j_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">j_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i_min</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">][</span><span class="s2">&quot;i_min&quot;</span><span class="p">]</span>
            <span class="n">i_max</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">][</span><span class="s2">&quot;i_max&quot;</span><span class="p">]</span>
            <span class="n">j_min</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">][</span><span class="s2">&quot;j_min&quot;</span><span class="p">]</span>
            <span class="n">j_max</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;zoom_window&quot;</span><span class="p">][</span><span class="s2">&quot;j_max&quot;</span><span class="p">]</span>
        <span class="n">grid_show</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i_min</span><span class="p">:</span><span class="n">i_max</span><span class="p">,</span> <span class="n">j_min</span><span class="p">:</span><span class="n">j_max</span><span class="p">]</span>
        <span class="n">grid_show_squared</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">make_square</span><span class="p">(</span><span class="n">grid_input</span><span class="o">=</span><span class="n">grid_show</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">grid_show_squared</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="c1"># extent=self.get_extent(),</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># todo the extent issue must be settled</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_autoscale_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Prevent auto-scaling which might add padding</span>

        <span class="c1"># plot helper geometry</span>
        <span class="n">helper_geometry</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">helper_geometry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">helper_geometry</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_map&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_map&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="c1"># handle tick labels</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;grid_map&quot;</span><span class="p">]:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;grid_map&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="c1"># ------------ areas plot ------------</span>
        <span class="n">n_w_legend</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="n">s_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;use_alias&quot;</span><span class="p">]:</span>
            <span class="n">s_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_alias</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
            <span class="n">df_areas</span><span class="p">[</span><span class="n">s_field</span><span class="p">],</span>
            <span class="o">-</span><span class="n">n_w_legend</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">df_areas</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_color</span><span class="p">],</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.16</span> <span class="o">*</span> <span class="n">viewer</span><span class="o">.</span><span class="n">MM_TO_PT</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
            <span class="n">df_areas</span><span class="p">[</span><span class="n">s_field</span><span class="p">],</span>
            <span class="n">df_areas</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span> <span class="o">+</span> <span class="s2">&quot;_f&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Add value labels on each bar</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_areas</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span> <span class="o">+</span> <span class="s2">&quot;_f&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">value</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">index</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontfamily</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># Add text label: (x, y, text)</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_areas&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;subtitle_areas&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">dc_units</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;km2&quot;</span><span class="p">:</span> <span class="s2">&quot;km$^2$&quot;</span><span class="p">,</span>
            <span class="s2">&quot;m2&quot;</span><span class="p">:</span> <span class="s2">&quot;m$^2$&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ha&quot;</span><span class="p">:</span> <span class="s2">&quot;ha&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">total_area</span> <span class="o">=</span> <span class="n">df_areas</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_area</span><span class="p">,</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;area_unit&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{:.1f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;total_area&quot;</span><span class="p">],</span> <span class="n">total_area</span><span class="p">,</span> <span class="n">dc_units</span><span class="p">[</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;area_unit&quot;</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">n_w_legend</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">Raster</span><span class="o">.</span><span class="n">plot_metadata</span><span class="p">(</span>
            <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="QualiRaster._set_view_specs">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster._set_view_specs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_view_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get default view specs</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle if there is no table</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListedColormap</span>

            <span class="c1"># handle no color field in table:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_color</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_random_colors</span><span class="p">()</span>

            <span class="c1"># hack for non-continuous ids:</span>
            <span class="n">_all_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">_lst_colors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_all_ids</span><span class="p">)):</span>
                <span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &gt;= </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">_color</span> <span class="o">=</span> <span class="n">_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_color</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_lst_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_color</span><span class="p">)</span>

            <span class="c1"># setup</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">_lst_colors</span><span class="p">),</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;tab:gray&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;use_alias&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;max_classes&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                    <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                    <span class="s2">&quot;subtitle_areas&quot;</span><span class="p">:</span> <span class="s2">&quot;Aereal ratios&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;area_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;km2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;total_area&quot;</span><span class="p">:</span> <span class="s2">&quot;Total area&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRaster.view">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRaster.view">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">helper_geometry</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays or returns a visualization of the spatial data and its area distribution.</span>

<span class="sd">        This method orchestrates the plotting process by setting up figure specifications,</span>
<span class="sd">        calling the internal plotting function (`_plot`), and then either displaying</span>
<span class="sd">        or saving the generated figure.</span>

<span class="sd">        :param show: If True, the plot is displayed. Default value = True</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param return_fig: If True, the matplotlib figure object is returned. Default value = False</span>
<span class="sd">        :type return_fig: bool</span>
<span class="sd">        :param helper_geometry: [optional] An optional geometry object to overlay on the map.</span>
<span class="sd">        :type helper_geometry: object</span>
<span class="sd">        :return: The matplotlib figure object if `return_fig` is True, otherwise None.</span>
<span class="sd">        :rtype: :class:`matplotlib.figure.Figure` or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle specs</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">specs_aux</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
            <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">FIG_SIZES</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="s2">&quot;w&quot;</span><span class="p">],</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">viewer</span><span class="o">.</span><span class="n">FIG_SIZES</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">][</span><span class="s2">&quot;h&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="c1"># update</span>
        <span class="n">specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">specs_aux</span><span class="p">)</span>
        <span class="c1"># update gridspecs</span>
        <span class="n">specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">GRID_SPECS</span><span class="p">)</span>
        <span class="c1"># update geometry</span>
        <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">helper_geometry</span>

        <span class="c1"># -------------- BUILD --------------</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">gs</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">build_fig</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>

        <span class="c1"># -------------- PLOT --------------</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">gs</span><span class="o">=</span><span class="n">gs</span><span class="p">,</span> <span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">)</span>

        <span class="c1"># -------------- SHIP --------------</span>
        <span class="c1"># create path</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;fig_format&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">viewer</span><span class="o">.</span><span class="n">ship_fig</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">file_output</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">])</span></div>
</div>



<div class="viewcode-block" id="QualiHard">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiHard">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QualiHard</span><span class="p">(</span><span class="n">QualiRaster</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Quali-Hard is a hard-coded qualitative map (that is, the table is pre-set)</span>
<span class="sd">    todo [docstring] -- examples</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="QualiHard.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiHard.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;qualihard&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;QualiRasterHard&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span> <span class="o">=</span> <span class="s2">&quot;QRH&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Preset Classes&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;classes ID&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_table</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">())</span></div>


<div class="viewcode-block" id="QualiHard.get_table">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiHard.get_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a DataFrame representing a classification table.</span>

<span class="sd">        :return: A DataFrame with classification data.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Class A&quot;</span><span class="p">,</span> <span class="s2">&quot;Class B&quot;</span><span class="p">,</span> <span class="s2">&quot;Class C&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_alias</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_color</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df_aux</span></div>


<div class="viewcode-block" id="QualiHard.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiHard.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">file_prj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">file_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data from file to the raster object.</span>

<span class="sd">        :param file_data: The path to the raster file.</span>
<span class="sd">        :type file_data: str</span>
<span class="sd">        :param file_prj: The path to the &#39;.prj&#39; projection file. If not provided, an attempt is made to use the same path and name as the ``.asc`` file with the &#39;.prj&#39; extension.</span>
<span class="sd">        :type file_prj: str</span>
<span class="sd">        :param id_band: Band id to read for GeoTIFF. Default value = 1</span>
<span class="sd">        :type id_band: int</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle extension</span>
        <span class="n">s_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s_extension</span> <span class="o">==</span> <span class="s2">&quot;asc&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_asc</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_tif</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span> <span class="n">id_band</span><span class="o">=</span><span class="n">id_band</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_prj</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_prj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="Zones">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Zones">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Zones</span><span class="p">(</span><span class="n">QualiRaster</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Zones map dataset is a QualiRaster designed to handle large volume of</span>
<span class="sd">    positive integer numbers (ids of zones)</span>
<span class="sd">    todo [docstring] -- examples</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Zones.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Zones.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ZonesMap&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint32&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;Zone&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span> <span class="o">=</span> <span class="s2">&quot;ZN&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Ids map of zones&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;zones ID&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Zones.compute_table">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Zones.compute_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes an internal table summarizing unique values in the spatial data,</span>
<span class="sd">        assigns aliases, names, and sets up viewing specifications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_nodata</span><span class="p">()</span>
            <span class="c1"># get unique values</span>
            <span class="n">vct_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># reapply mask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_nodata</span><span class="p">()</span>
            <span class="c1"># set table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">:</span> <span class="n">vct_unique</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">field_alias</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varalias</span><span class="p">,</span> <span class="n">vct_unique</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vct_unique</span><span class="p">))</span>
                    <span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span> <span class="n">vct_unique</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vct_unique</span><span class="p">))</span>
                    <span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">[</span><span class="s2">&quot;NODATA_value&quot;</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_random_colors</span><span class="p">()</span>
            <span class="c1"># set view specs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span>
            <span class="c1"># fix some view_specs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;b_xlabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zones ID&quot;</span>
            <span class="k">del</span> <span class="n">vct_unique</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Zones.set_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Zones.set_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the spatial data for the object and recomputes the internal table.</span>

<span class="sd">        :param grid: The input grid data.</span>
<span class="sd">        :type grid: :class:`numpy.ndarray`</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_table</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Zones.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Zones.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asc_file</span><span class="p">,</span> <span class="n">prj_file</span><span class="p">):</span>
        <span class="c1"># todo [refactor] -- this is deprecated -- use load tifs</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data from files to raster</span>

<span class="sd">        :param asc_file: path to raster file</span>
<span class="sd">        :type asc_file: str</span>
<span class="sd">        :param prj_file: path to projection file</span>
<span class="sd">        :type prj_file: str</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_asc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">asc_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_prj</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">prj_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Zones.get_aoi">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Zones.get_aoi">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_aoi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zone_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the AOI map from a zone id</span>

<span class="sd">        :param zone_id: number of zone ID</span>
<span class="sd">        :type zone_id: int</span>
<span class="sd">        :return: AOI map</span>
<span class="sd">        :rtype: :class:`AOI`` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">plans.datasets.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">AOI</span>

        <span class="n">map_aoi</span> <span class="o">=</span> <span class="n">AOI</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span> <span class="n">zone_id</span><span class="p">))</span>
        <span class="n">map_aoi</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">)</span>
        <span class="n">map_aoi</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prj</span>
        <span class="c1"># set grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_nodata</span><span class="p">()</span>
        <span class="n">map_aoi</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">zone_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_nodata</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">map_aoi</span></div>


<div class="viewcode-block" id="Zones.view">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.Zones.view">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;./output&quot;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">specs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
        <span class="n">fig_format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># todo [refactor] -- DRY</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a basic pannel of raster map.</span>

<span class="sd">        :param show: boolean to show plot instead of saving, defaults to False</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param folder: path to output folder, defaults to ``./output``</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: name of file, defaults to None</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param specs: specifications dictionary, defaults to None</span>
<span class="sd">        :type specs: dict</span>
<span class="sd">        :param dpi: image resolution, defaults to 96</span>
<span class="sd">        :type dpi: int</span>
<span class="sd">        :param fig_format: image fig_format (ex: png or jpg). Default jpg</span>
<span class="sd">        :type fig_format: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set Raster map for plotting</span>
        <span class="n">map_zones_aux</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># set up</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varname</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">varalias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">set_raster_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raster_metadata</span><span class="p">)</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prj</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;tab20&quot;</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># grid setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_nodata</span><span class="p">()</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_nodata</span><span class="p">()</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">_set_view_specs</span><span class="p">()</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpi</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;fig_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig_format</span>
        <span class="c1"># update extra view specs:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">:</span>
            <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="c1"># call view</span>
        <span class="n">map_zones_aux</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
            <span class="n">accum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">map_zones_aux</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<span class="c1"># Core spatial classes -- collections</span>
<span class="c1"># -----------------------------------------------------------------------</span>


<div class="viewcode-block" id="RasterCollection">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RasterCollection</span><span class="p">(</span><span class="n">Collection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The raster collection base dataset.</span>
<span class="sd">    This data strucute is designed for holding and comparing :class:`Raster`` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RasterCollection.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;myRasterCollection&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy the raster collection data structure.</span>

<span class="sd">        :param name: name of raster collection</span>
<span class="sd">        :type name: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj_aux</span> <span class="o">=</span> <span class="n">Raster</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">base_object</span><span class="o">=</span><span class="n">obj_aux</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># set up date fields and special attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_catalog_ls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alias&quot;</span><span class="p">,</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolution&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rows&quot;</span><span class="p">,</span>
            <span class="s2">&quot;columns&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xll&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yll&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nodata_value&quot;</span><span class="p">,</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="RasterCollection._set_fields">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection._set_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set fields names.</span>
<span class="sd">        Expected to increment superior methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ------------ call super ----------- #</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_fields</span><span class="p">()</span>

        <span class="c1"># Attribute fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">()</span><span class="o">.</span><span class="n">field_datetime</span></div>

        <span class="c1"># ... continues in downstream objects ... #</span>

<div class="viewcode-block" id="RasterCollection.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">file_data</span><span class="p">,</span>
        <span class="n">file_prj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">varname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">varalias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span>
        <span class="n">skip_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a :class:`Raster`` base_object from a raster file.</span>

<span class="sd">        :param name: :class:`Raster.name`` name attribute</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param file_data: path to raster file</span>
<span class="sd">        :type file_data: str</span>
<span class="sd">        :param varname: :class:`Raster.varname`` variable name attribute, defaults to None</span>
<span class="sd">        :type varname: str</span>
<span class="sd">        :param varalias: :class:`Raster.varalias`` variable alias attribute, defaults to None</span>
<span class="sd">        :type varalias: str</span>
<span class="sd">        :param units: :class:`Raster.units`` units attribute, defaults to None</span>
<span class="sd">        :type units: str</span>
<span class="sd">        :param datetime: :class:`Raster.date`` date attribute, defaults to None</span>
<span class="sd">        :type datetime: str</span>
<span class="sd">        :param skip_grid: option for loading only the metadata</span>
<span class="sd">        :type skip_grid: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create raster</span>
        <span class="n">rst_aux</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># set attributes</span>
        <span class="n">rst_aux</span><span class="o">.</span><span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span>
        <span class="n">rst_aux</span><span class="o">.</span><span class="n">varalias</span> <span class="o">=</span> <span class="n">varalias</span>
        <span class="n">rst_aux</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
        <span class="n">rst_aux</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span>

        <span class="c1"># load projection file</span>
        <span class="n">rst_aux</span><span class="o">.</span><span class="n">load_prj</span><span class="p">(</span><span class="n">file_input</span><span class="o">=</span><span class="n">file_prj</span><span class="p">)</span>

        <span class="c1"># read data file</span>
        <span class="k">if</span> <span class="n">skip_grid</span><span class="p">:</span>
            <span class="n">rst_aux</span><span class="o">.</span><span class="n">load_metadata</span><span class="p">(</span><span class="n">file_data</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rst_aux</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">file_data</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>

        <span class="c1"># append to collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_object</span><span class="o">=</span><span class="n">rst_aux</span><span class="p">)</span>

        <span class="c1"># delete aux</span>
        <span class="k">del</span> <span class="n">rst_aux</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># todo [develop] -- optimize</span>
    <span class="c1"># todo [develop] -- parallel loading</span>
<div class="viewcode-block" id="RasterCollection.load_folder">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.load_folder">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_folder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">folder</span><span class="p">,</span>
        <span class="n">name_pattern</span><span class="p">,</span>
        <span class="n">is_series</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">file_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">file_format</span><span class="o">=</span><span class="s2">&quot;tif&quot;</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load all rasters from a folder by following a name pattern.</span>

<span class="sd">        :param folder: path to folder</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param name_pattern: name pattern. example map_*</span>
<span class="sd">        :type name_pattern: str</span>
<span class="sd">        :param is_series: flag to handle datetime</span>
<span class="sd">        :type is_series: bool</span>
<span class="sd">        :param file_table: file path to qualiraster table</span>
<span class="sd">        :type file_table: str or Path</span>
<span class="sd">        :param verbose: option for printing messages</span>
<span class="sd">        :type verbose: bool</span>
<span class="sd">        :param file_format: file extension.</span>
<span class="sd">        :type file_format: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">print_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># list files</span>
        <span class="n">lst_maps</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">,</span> <span class="n">file_format</span><span class="p">))</span>
        <span class="n">lst_prjs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.prj&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">))</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;loading folder: </span><span class="si">{}</span><span class="s2"> files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lst_maps</span><span class="p">))</span>
        <span class="n">print_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># enter serial loop</span>
        <span class="c1"># -------------------------------------------------------</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lst_maps</span><span class="p">)):</span>

            <span class="n">map_file</span> <span class="o">=</span> <span class="n">lst_maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># handle missing projection files</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst_prjs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prj_file</span> <span class="o">=</span> <span class="n">lst_prjs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prj_file</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># get name</span>
            <span class="n">s_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">map_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># load file</span>

            <span class="c1"># handle if is a series map</span>
            <span class="k">if</span> <span class="n">is_series</span><span class="p">:</span>
                <span class="c1"># get local datetime assuming is ar</span>
                <span class="n">s_date_map</span> <span class="o">=</span> <span class="n">map_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">file_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># simple raster series</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">s_name</span><span class="p">,</span>
                        <span class="n">datetime</span><span class="o">=</span><span class="n">s_date_map</span><span class="p">,</span>
                        <span class="n">file_data</span><span class="o">=</span><span class="n">map_file</span><span class="p">,</span>
                        <span class="n">prj_file</span><span class="o">=</span><span class="n">prj_file</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># quali raster series</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">s_name</span><span class="p">,</span>
                        <span class="n">datetime</span><span class="o">=</span><span class="n">s_date_map</span><span class="p">,</span>
                        <span class="n">file_data</span><span class="o">=</span><span class="n">map_file</span><span class="p">,</span>
                        <span class="n">file_table</span><span class="o">=</span><span class="n">file_table</span><span class="p">,</span>
                        <span class="n">file_prj</span><span class="o">=</span><span class="n">prj_file</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># simple raster collection</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">s_name</span><span class="p">,</span>
                        <span class="n">file_data</span><span class="o">=</span><span class="n">map_file</span><span class="p">,</span>
                        <span class="n">prj_file</span><span class="o">=</span><span class="n">prj_file</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># quali raster collection</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">s_name</span><span class="p">,</span>
                        <span class="n">file_data</span><span class="o">=</span><span class="n">map_file</span><span class="p">,</span>
                        <span class="n">prj_file</span><span class="o">=</span><span class="n">prj_file</span><span class="p">,</span>
                        <span class="n">file_table</span><span class="o">=</span><span class="n">file_table</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># messages</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst_maps</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{:7.2f}</span><span class="s2">%] loaded: </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s_name</span><span class="p">,</span> <span class="n">file_format</span><span class="p">)</span>
            <span class="n">print_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RasterCollection.is_same_grid">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.is_same_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_same_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if all datasets in the catalog have the same grid dimensions (number of columns and rows).</span>

<span class="sd">        :return: True if all datasets have the same grid dimensions, False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;ncols&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">u_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;nrows&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">u_cols</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">u_rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="RasterCollection.reduce">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.reduce">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reduce</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">reducer_func</span><span class="p">,</span>
        <span class="n">reduction_name</span><span class="p">,</span>
        <span class="n">extra_arg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method reduces the collection by applying a numpy broadcasting function (example: np.mean)</span>

<span class="sd">        :param reducer_func: reducer numpy function (example: np.mean)</span>
<span class="sd">        :type reducer_func: numpy function</span>
<span class="sd">        :param reduction_name: name for the output raster</span>
<span class="sd">        :type reduction_name: str</span>
<span class="sd">        :param extra_arg: extra argument for function (example: np.percentiles) - Default: None</span>
<span class="sd">        :type extra_arg: any</span>
<span class="sd">        :param skip_nan: Option for skipping NaN values in map</span>
<span class="sd">        :type skip_nan: bool</span>
<span class="sd">        :param talk: option for printing messages</span>
<span class="sd">        :type talk: bool</span>
<span class="sd">        :return: raster object based on the first object found in the collection</span>
<span class="sd">        :rtype: :class:`Raster`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

        <span class="c1"># return None if there is different grids</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_same_grid</span><span class="p">():</span>
            <span class="c1"># get shape parameters</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)</span>
            <span class="n">_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n_flat</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_first</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_first</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># create the merged grid</span>
            <span class="n">grd_merged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n_flat</span><span class="p">))</span>
            <span class="c1"># insert the flat arrays</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">_vct_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">grd_merged</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_vct_flat</span>
            <span class="c1"># transpose</span>
            <span class="n">grd_merged_T</span> <span class="o">=</span> <span class="n">grd_merged</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

            <span class="c1"># setup stats vector</span>
            <span class="n">vct_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_flat</span><span class="p">)</span>
            <span class="c1"># fill vector</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_flat</span><span class="p">):</span>
                <span class="n">_vct</span> <span class="o">=</span> <span class="n">grd_merged_T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># remove NaN</span>
                <span class="k">if</span> <span class="n">skip_nan</span><span class="p">:</span>
                    <span class="n">_vct</span> <span class="o">=</span> <span class="n">_vct</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_vct</span><span class="p">)]</span>
                    <span class="c1"># handle void vector</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_vct</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_vct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">if</span> <span class="n">extra_arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">vct_stats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">reducer_func</span><span class="p">(</span><span class="n">_vct</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vct_stats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">reducer_func</span><span class="p">(</span><span class="n">_vct</span><span class="p">,</span> <span class="n">extra_arg</span><span class="p">)</span>

            <span class="c1"># reshape</span>
            <span class="n">grd_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">a</span><span class="o">=</span><span class="n">vct_stats</span><span class="p">,</span> <span class="n">newshape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_first</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="p">)</span>
            <span class="c1"># return set up</span>
            <span class="n">output_raster</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_first</span><span class="p">])</span>
            <span class="n">output_raster</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">grd_stats</span><span class="p">)</span>
            <span class="n">output_raster</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">reduction_name</span>
            <span class="k">return</span> <span class="n">output_raster</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">talk</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: different grids found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RasterCollection.to_mean">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.to_mean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce Collection to the Mean raster</span>

<span class="sd">        :param skip_nan: Option for skipping NaN values in map</span>
<span class="sd">        :type skip_nan: bool</span>
<span class="sd">        :param talk: option for printing messages</span>
<span class="sd">        :type talk: bool</span>
<span class="sd">        :return: raster object based on the first object found in the collection</span>
<span class="sd">        :rtype: :class:`Raster`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">reducer_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
            <span class="n">reduction_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Mean&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">skip_nan</span><span class="o">=</span><span class="n">skip_nan</span><span class="p">,</span>
            <span class="n">talk</span><span class="o">=</span><span class="n">talk</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output_raster</span></div>


<div class="viewcode-block" id="RasterCollection.to_sd">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.to_sd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_sd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce Collection to the Standard Deviation raster</span>

<span class="sd">        :param skip_nan: Option for skipping NaN values in map</span>
<span class="sd">        :type skip_nan: bool</span>
<span class="sd">        :param talk: option for printing messages</span>
<span class="sd">        :type talk: bool</span>
<span class="sd">        :return: raster object based on the first object found in the collection</span>
<span class="sd">        :rtype: :class:`Raster`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">reducer_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">,</span>
            <span class="n">reduction_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> SD&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">skip_nan</span><span class="o">=</span><span class="n">skip_nan</span><span class="p">,</span>
            <span class="n">talk</span><span class="o">=</span><span class="n">talk</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output_raster</span></div>


<div class="viewcode-block" id="RasterCollection.to_min">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.to_min">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce Collection to the Min raster</span>

<span class="sd">        :param skip_nan: Option for skipping NaN values in map</span>
<span class="sd">        :type skip_nan: bool</span>
<span class="sd">        :param talk: option for printing messages</span>
<span class="sd">        :type talk: bool</span>
<span class="sd">        :return: raster object based on the first object found in the collection</span>
<span class="sd">        :rtype: :class:`Raster`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">reducer_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
            <span class="n">reduction_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Min&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">skip_nan</span><span class="o">=</span><span class="n">skip_nan</span><span class="p">,</span>
            <span class="n">talk</span><span class="o">=</span><span class="n">talk</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output_raster</span></div>


<div class="viewcode-block" id="RasterCollection.to_max">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.to_max">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce Collection to the Max raster</span>

<span class="sd">        :param skip_nan: Option for skipping NaN values in map</span>
<span class="sd">        :type skip_nan: bool</span>
<span class="sd">        :param talk: option for printing messages</span>
<span class="sd">        :type talk: bool</span>
<span class="sd">        :return: raster object based on the first object found in the collection</span>
<span class="sd">        :rtype: :class:`Raster`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">reducer_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
            <span class="n">reduction_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Max&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">skip_nan</span><span class="o">=</span><span class="n">skip_nan</span><span class="p">,</span>
            <span class="n">talk</span><span class="o">=</span><span class="n">talk</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output_raster</span></div>


<div class="viewcode-block" id="RasterCollection.to_sum">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.to_sum">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce Collection to the Sum raster</span>

<span class="sd">        :param skip_nan: Option for skipping NaN values in map</span>
<span class="sd">        :type skip_nan: bool</span>
<span class="sd">        :param talk: option for printing messages</span>
<span class="sd">        :type talk: bool</span>
<span class="sd">        :return: raster object based on the first object found in the collection</span>
<span class="sd">        :rtype: :class:`Raster`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">reducer_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span>
            <span class="n">reduction_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Sum&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">skip_nan</span><span class="o">=</span><span class="n">skip_nan</span><span class="p">,</span>
            <span class="n">talk</span><span class="o">=</span><span class="n">talk</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output_raster</span></div>


<div class="viewcode-block" id="RasterCollection.to_percentile">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.to_percentile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_percentile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">skip_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce Collection to the Nth Percentile raster</span>

<span class="sd">        :param percentile: Nth percentile (from 0 to 100)</span>
<span class="sd">        :type percentile: float</span>
<span class="sd">        :param skip_nan: Option for skipping NaN values in map</span>
<span class="sd">        :type skip_nan: bool</span>
<span class="sd">        :param talk: option for printing messages</span>
<span class="sd">        :type talk: bool</span>
<span class="sd">        :return: raster object based on the first object found in the collection</span>
<span class="sd">        :rtype: :class:`Raster`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">reducer_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">,</span>
            <span class="n">reduction_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">th percentile&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">percentile</span><span class="p">)),</span>
            <span class="n">skip_nan</span><span class="o">=</span><span class="n">skip_nan</span><span class="p">,</span>
            <span class="n">talk</span><span class="o">=</span><span class="n">talk</span><span class="p">,</span>
            <span class="n">extra_arg</span><span class="o">=</span><span class="n">percentile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output_raster</span></div>


<div class="viewcode-block" id="RasterCollection.to_median">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.to_median">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_median</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reduce Collection to the Median raster</span>

<span class="sd">        :param skip_nan: Option for skipping NaN values in map</span>
<span class="sd">        :type skip_nan: bool</span>
<span class="sd">        :param talk: option for printing messages</span>
<span class="sd">        :type talk: bool</span>
<span class="sd">        :return: raster object based on the first object found in the collection</span>
<span class="sd">        :rtype: :class:`Raster`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_raster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">reducer_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">,</span>
            <span class="n">reduction_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Median&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">skip_nan</span><span class="o">=</span><span class="n">skip_nan</span><span class="p">,</span>
            <span class="n">talk</span><span class="o">=</span><span class="n">talk</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">output_raster</span></div>


<div class="viewcode-block" id="RasterCollection.get_collection_stats">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.get_collection_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get basic statistics from collection.</span>

<span class="sd">        :return: statistics sample</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># deploy dataframe</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lst_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="n">s_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">s_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_stats_df</span><span class="p">()</span>
            <span class="n">lst_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># deploy fields</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_stats</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]:</span>
            <span class="n">df_aux</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># fill values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_aux</span><span class="p">)):</span>
            <span class="n">df_aux</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lst_stats</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># convert to integer</span>
        <span class="n">df_aux</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_aux</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint32&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_aux</span></div>


<div class="viewcode-block" id="RasterCollection.get_views">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.get_views">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_views</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;./output&quot;</span><span class="p">,</span>
        <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">fig_format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
        <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">specs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot all basic pannel of raster maps in collection.</span>

<span class="sd">        :param show: boolean to show plot instead of saving,</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param folder: path to output folder, defaults to ``./output``</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param dpi: image resolution, defaults to 96</span>
<span class="sd">        :type dpi: int</span>
<span class="sd">        :param fig_format: image fig_format (ex: png or jpg). Default jpg</span>
<span class="sd">        :type fig_format: str</span>
<span class="sd">        :param talk: option for print messages</span>
<span class="sd">        :type talk: bool</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># enter serial plot loop</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>

            <span class="c1"># get local raster</span>
            <span class="n">rst_lcl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="c1"># update incoming specs</span>
            <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rst_lcl</span><span class="o">.</span><span class="n">view_specs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

            <span class="c1"># setup hard viewspecs</span>
            <span class="n">s_name</span> <span class="o">=</span> <span class="n">rst_lcl</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s_name</span> <span class="o">=</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">rst_lcl</span><span class="o">.</span><span class="n">name</span>
            <span class="n">rst_lcl</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_name</span>
            <span class="n">rst_lcl</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder</span>
            <span class="n">rst_lcl</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpi</span>
            <span class="n">rst_lcl</span><span class="o">.</span><span class="n">view_specs</span><span class="p">[</span><span class="s2">&quot;fig_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig_format</span>

            <span class="c1"># view</span>
            <span class="k">if</span> <span class="n">talk</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;plotting view of </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rst_lcl</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">rst_lcl</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RasterCollection.view_bboxes">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.view_bboxes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view_bboxes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">datapoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;./output&quot;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
        <span class="n">fig_format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        View Bounding Boxes of Raster collection</span>

<span class="sd">        :param colors: list of colors for plotting. expected to be the same runsize of catalog</span>
<span class="sd">        :type colors: list</span>
<span class="sd">        :param datapoints: option to plot datapoints as well, defaults to False</span>
<span class="sd">        :type datapoints: bool</span>
<span class="sd">        :param show: option to show plot instead of saving, defaults to False</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param folder: path to output folder, defaults to ``./output``</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: name of file, defaults to None</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param dpi: image resolution, defaults to 96</span>
<span class="sd">        :type dpi: int</span>
<span class="sd">        :param fig_format: image fig_format (ex: png or jpg). Default jpg</span>
<span class="sd">        :type fig_format: str</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="c1"># get colors</span>
        <span class="n">lst_colors</span> <span class="o">=</span> <span class="n">colors</span>
        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lst_colors</span> <span class="o">=</span> <span class="n">get_colors</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">))</span>
        <span class="c1"># colect names and bboxes</span>
        <span class="n">lst_x_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">lst_y_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">dct_bboxes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">dct_colors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">_c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="n">dct_colors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lst_colors</span><span class="p">[</span><span class="n">_c</span><span class="p">]</span>
            <span class="n">lcl_bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get_bbox</span><span class="p">()</span>
            <span class="n">dct_bboxes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcl_bbox</span>
            <span class="c1"># append coordinates</span>
            <span class="n">lst_x_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lcl_bbox</span><span class="p">[</span><span class="s2">&quot;xmin&quot;</span><span class="p">])</span>
            <span class="n">lst_x_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lcl_bbox</span><span class="p">[</span><span class="s2">&quot;xmax&quot;</span><span class="p">])</span>
            <span class="n">lst_y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lcl_bbox</span><span class="p">[</span><span class="s2">&quot;ymin&quot;</span><span class="p">])</span>
            <span class="n">lst_y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lcl_bbox</span><span class="p">[</span><span class="s2">&quot;ymax&quot;</span><span class="p">])</span>
            <span class="n">_c</span> <span class="o">=</span> <span class="n">_c</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># get min and max</span>
        <span class="n">n_xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lst_x_values</span><span class="p">)</span>
        <span class="n">n_xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lst_x_values</span><span class="p">)</span>
        <span class="n">n_ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lst_y_values</span><span class="p">)</span>
        <span class="n">n_ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lst_y_values</span><span class="p">)</span>
        <span class="c1"># get ranges</span>
        <span class="n">n_x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">n_xmax</span> <span class="o">-</span> <span class="n">n_xmin</span><span class="p">)</span>
        <span class="n">n_y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">n_ymax</span> <span class="o">-</span> <span class="n">n_ymin</span><span class="p">)</span>

        <span class="c1"># plot loop</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dct_bboxes</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">dct_bboxes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span>
                <span class="n">dct_bboxes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;ymin&quot;</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">dct_colors</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">datapoints</span><span class="p">:</span>
                <span class="n">df_dpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get_grid_datapoints</span><span class="p">(</span><span class="n">drop_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">df_dpoints</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">df_dpoints</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">dct_colors</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span>
                <span class="p">)</span>
            <span class="n">_w</span> <span class="o">=</span> <span class="n">dct_bboxes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;xmax&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dct_bboxes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;xmin&quot;</span><span class="p">]</span>
            <span class="n">_h</span> <span class="o">=</span> <span class="n">dct_bboxes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;ymax&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dct_bboxes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;ymin&quot;</span><span class="p">]</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">dct_bboxes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;xmin&quot;</span><span class="p">],</span> <span class="n">dct_bboxes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;ymin&quot;</span><span class="p">]),</span>
                <span class="n">width</span><span class="o">=</span><span class="n">_w</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="n">_h</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">dct_colors</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">n_ymin</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_y_range</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span> <span class="n">n_ymax</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_y_range</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">n_xmin</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_x_range</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span> <span class="n">n_xmax</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_x_range</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="c1"># show or save</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;bboxes&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fig_format</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RasterCollection.get_catalog">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterCollection.get_catalog">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the data catalog in different modes.</span>

<span class="sd">        :param mode: The mode of the catalog to retrieve. Can be &quot;full&quot; for the complete catalog, &quot;short&quot; for a truncated version, or any other value to filter by a list `ls`. Default value = &quot;full&quot;</span>
<span class="sd">        :type mode: str</span>
<span class="sd">        :return: The requested data catalog.</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;short&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">short_catalog_ls</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">ls</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="QualiRasterCollection">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterCollection">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QualiRasterCollection</span><span class="p">(</span><span class="n">RasterCollection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The raster collection base dataset.</span>

<span class="sd">    This data strucute is designed for holding and comparing :class:`QualiRaster`` objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="QualiRasterCollection.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterCollection.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy Qualitative Raster Series</span>

<span class="sd">        :param name: :class:`RasterSeries.name`` name attribute</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param varname: :class:`Raster.varname`` variable name attribute, defaults to None</span>
<span class="sd">        :type varname: str</span>
<span class="sd">        :param varalias: :class:`Raster.varalias`` variable alias attribute, defaults to None</span>
<span class="sd">        :type varalias: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="QualiRasterCollection.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterCollection.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">file_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prj_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a :class:`QualiRaster`` from file.</span>

<span class="sd">        :param name: :class:`Raster.name`` name attribute</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param file_data: path to raster file.</span>
<span class="sd">        :type file_data: str</span>
<span class="sd">        :param file_table: path to table file</span>
<span class="sd">        :type file_table: str</span>
<span class="sd">        :param prj_file: path to projection file</span>
<span class="sd">        :type prj_file: str</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create raster</span>
        <span class="n">rst_aux</span> <span class="o">=</span> <span class="n">QualiRaster</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># todo evaluate to include other attributes</span>
        <span class="c1"># read file</span>
        <span class="n">rst_aux</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">file_data</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span> <span class="n">file_table</span><span class="o">=</span><span class="n">file_table</span><span class="p">,</span> <span class="n">prj_file</span><span class="o">=</span><span class="n">prj_file</span><span class="p">)</span>

        <span class="c1"># append to collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_object</span><span class="o">=</span><span class="n">rst_aux</span><span class="p">)</span>

        <span class="c1"># delete aux</span>
        <span class="k">del</span> <span class="n">rst_aux</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="RasterSeries">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterSeries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RasterSeries</span><span class="p">(</span><span class="n">RasterCollection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`RasterCollection`` where datetime matters and all maps in collections are</span>
<span class="sd">    expected to be the same variable, same projection and same grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RasterSeries.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterSeries.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">varalias</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy RasterSeries</span>

<span class="sd">        :param name: :class:`RasterSeries.name`` name attribute</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param varname: :class:`Raster.varname`` variable name attribute, defaults to None</span>
<span class="sd">        :type varname: str</span>
<span class="sd">        :param varalias: :class:`Raster.varalias`` variable alias attribute, defaults to None</span>
<span class="sd">        :type varalias: str</span>
<span class="sd">        :param units: :class:`Raster.units`` units attribute, defaults to None</span>
<span class="sd">        :type units: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varname</span> <span class="o">=</span> <span class="n">varname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varalias</span> <span class="o">=</span> <span class="n">varalias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span></div>


<div class="viewcode-block" id="RasterSeries.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterSeries.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">prj_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">skip_grid</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a :class:`Raster`` object from raster file.</span>

<span class="sd">        :param name: :class:`Raster.name`` name attribute</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param datetime: :class:`Raster.date`` date attribute, defaults to None</span>
<span class="sd">        :type datetime: str</span>
<span class="sd">        :param file_data: path to raster file</span>
<span class="sd">        :type file_data: str</span>
<span class="sd">        :param prj_file: path to projection file</span>
<span class="sd">        :type prj_file: str</span>
<span class="sd">        :param skip_grid: option for loading only the metadata</span>
<span class="sd">        :type skip_grid: bool</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">file_data</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span>
            <span class="n">file_prj</span><span class="o">=</span><span class="n">prj_file</span><span class="p">,</span>
            <span class="n">varname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span>
            <span class="n">varalias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">varalias</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">datetime</span><span class="o">=</span><span class="n">datetime</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">skip_grid</span><span class="o">=</span><span class="n">skip_grid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RasterSeries.load_folder">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterSeries.load_folder">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_folder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">folder</span><span class="p">,</span>
        <span class="n">name_pattern</span><span class="p">,</span>
        <span class="n">file_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">file_format</span><span class="o">=</span><span class="s2">&quot;tif&quot;</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_folder</span><span class="p">(</span>
            <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
            <span class="n">name_pattern</span><span class="o">=</span><span class="n">name_pattern</span><span class="p">,</span>
            <span class="n">is_series</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">file_table</span><span class="o">=</span><span class="n">file_table</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">file_format</span><span class="o">=</span><span class="n">file_format</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RasterSeries.apply_aoi_masks">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterSeries.apply_aoi_masks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_aoi_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_aoi</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Batch method to apply AOI mask over all maps in collection</span>

<span class="sd">        :param grid_aoi: aoi grid</span>
<span class="sd">        :type grid_aoi: :class:`numpy.ndarray`</span>
<span class="sd">        :param inplace: overwrite the main grid if True, defaults to False</span>
<span class="sd">        :type inplace: bool</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">apply_aoi_mask</span><span class="p">(</span><span class="n">grid_aoi</span><span class="o">=</span><span class="n">grid_aoi</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RasterSeries.release_aoi_masks">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterSeries.release_aoi_masks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">release_aoi_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Batch method to release the AOI mask over all maps in collection</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">release_aoi_mask</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RasterSeries.rebase_grids">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterSeries.rebase_grids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rebase_grids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_raster</span><span class="p">,</span> <span class="n">talk</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Batch method for rebase all maps in collection</span>

<span class="sd">        :param base_raster: base raster for rebasing</span>
<span class="sd">        :type base_raster: :class:`datasets.Raster`</span>
<span class="sd">        :param talk: option for print messages</span>
<span class="sd">        :type talk: bool</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">talk</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rebase grids...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">rebase_grid</span><span class="p">(</span><span class="n">base_raster</span><span class="o">=</span><span class="n">base_raster</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RasterSeries.get_series_stats">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterSeries.get_series_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_series_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the raster series statistics</span>

<span class="sd">        :return: dataframe of raster series statistics</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rst_aux</span> <span class="o">=</span> <span class="n">Raster</span><span class="p">()</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection_stats</span><span class="p">()</span>
        <span class="n">df_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[[</span><span class="n">rst_aux</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="n">rst_aux</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">]],</span>
            <span class="n">df_stats</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="n">rst_aux</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df_series</span></div>


<div class="viewcode-block" id="RasterSeries.view_series_stats">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.RasterSeries.view_series_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">view_series_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;./output&quot;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">specs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
        <span class="n">fig_format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        View raster series statistics</span>

<span class="sd">        :param statistic: statistc to view. Default mean</span>
<span class="sd">        :type statistic: str</span>
<span class="sd">        :param show: option to show plot instead of saving, defaults to False</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param folder: path to output folder, defaults to ``./output``</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: name of file, defaults to None</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param specs: specifications dictionary, defaults to None</span>
<span class="sd">        :type specs: dict</span>
<span class="sd">        :param dpi: image resolution, defaults to 96</span>
<span class="sd">        :type dpi: int</span>
<span class="sd">        :param fig_format: image fig_format (ex: png or jpg). Default jpg</span>
<span class="sd">        :type fig_format: str</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_series_stats</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">DailySeries</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span> <span class="n">statistic</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
            <span class="n">dataframe</span><span class="o">=</span><span class="n">df_series</span><span class="p">,</span> <span class="n">varfield</span><span class="o">=</span><span class="n">statistic</span><span class="p">,</span> <span class="n">datefield</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span>
        <span class="p">)</span>
        <span class="n">default_specs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> | </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> series&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varname</span><span class="p">,</span> <span class="n">statistic</span><span class="p">),</span>
            <span class="s2">&quot;ylabel&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="n">default_specs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># overwrite incoming specs</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_specs</span><span class="p">:</span>
                <span class="n">specs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_specs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
            <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">,</span>
            <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">specs</span><span class="o">=</span><span class="n">specs</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
            <span class="n">fig_format</span><span class="o">=</span><span class="n">fig_format</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="QualiRasterSeries">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterSeries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QualiRasterSeries</span><span class="p">(</span><span class="n">RasterSeries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`RasterSeries` where date matters and all maps in collections are</span>
<span class="sd">    expected to be :class:`QualiRaster`` with the same variable, same projection and same grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="QualiRasterSeries.__init__">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterSeries.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">varalias</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy Qualitative Raster Series</span>

<span class="sd">        :param name: :class:`RasterSeries.name`` name attribute</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param varname: :class:`Raster.varname` variable name attribute, defaults to None</span>
<span class="sd">        :type varname: str</span>
<span class="sd">        :param varalias: :class:`Raster.varalias` variable alias attribute, defaults to None</span>
<span class="sd">        :type varalias: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span> <span class="n">varalias</span><span class="o">=</span><span class="n">varalias</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;ID&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRasterSeries.update_table">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterSeries.update_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update series table (attributes)</span>

<span class="sd">        :param clear: option for clear table from unfound values. default: True</span>
<span class="sd">        :type clear: bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)):</span>
                <span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># clear table from unfound values</span>
                <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">clear_table</span><span class="p">()</span>
                <span class="c1"># concat all tables</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
                    <span class="p">)</span>
        <span class="c1"># clear from duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="n">QualiRaster</span><span class="p">()</span><span class="o">.</span><span class="n">field_id</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;last&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRasterSeries.append">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterSeries.append">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raster</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_object</span><span class="o">=</span><span class="n">raster</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_table</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRasterSeries.load_data">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterSeries.load_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">prj_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a :class:`QualiRaster` base_object from raster file.</span>

<span class="sd">        :param name: :class:`Raster.name` name attribute</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param datetime: :class:`Raster.date` date attribute</span>
<span class="sd">        :type datetime: str</span>
<span class="sd">        :param file_data: path to raster file</span>
<span class="sd">        :type file_data: str</span>
<span class="sd">        :param prj_file: path to projection file</span>
<span class="sd">        :type prj_file: str</span>
<span class="sd">        :param table_file: path to ``.txt`` table file</span>
<span class="sd">        :type table_file: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create raster</span>
        <span class="n">rst_aux</span> <span class="o">=</span> <span class="n">QualiRaster</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># set attributes</span>
        <span class="n">rst_aux</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span>
        <span class="c1"># read file</span>
        <span class="n">rst_aux</span><span class="o">.</span><span class="n">load_asc</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file_data</span><span class="p">)</span>
        <span class="c1"># load prj</span>
        <span class="k">if</span> <span class="n">prj_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rst_aux</span><span class="o">.</span><span class="n">load_prj</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">prj_file</span><span class="p">)</span>
        <span class="c1"># set table</span>
        <span class="k">if</span> <span class="n">table_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rst_aux</span><span class="o">.</span><span class="n">load_table</span><span class="p">(</span><span class="n">file_table</span><span class="o">=</span><span class="n">table_file</span><span class="p">)</span>
        <span class="c1"># append to collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_object</span><span class="o">=</span><span class="n">rst_aux</span><span class="p">)</span>
        <span class="c1"># delete aux</span>
        <span class="k">del</span> <span class="n">rst_aux</span></div>


<div class="viewcode-block" id="QualiRasterSeries.w_load_file">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterSeries.w_load_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">w_load_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Worker function to load a single file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s_name</span><span class="p">,</span> <span class="n">s_date_map</span><span class="p">,</span> <span class="n">asc_file</span><span class="p">,</span> <span class="n">prj_file</span><span class="p">,</span> <span class="n">table_file</span> <span class="o">=</span> <span class="n">file_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">s_name</span><span class="p">,</span>
            <span class="n">datetime</span><span class="o">=</span><span class="n">s_date_map</span><span class="p">,</span>
            <span class="n">file_data</span><span class="o">=</span><span class="n">asc_file</span><span class="p">,</span>
            <span class="n">prj_file</span><span class="o">=</span><span class="n">prj_file</span><span class="p">,</span>
            <span class="n">table_file</span><span class="o">=</span><span class="n">table_file</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="c1"># todo [DRY] -- this seems duplicated except by the file_table parameters</span>

<div class="viewcode-block" id="QualiRasterSeries.load_folder">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterSeries.load_folder">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_folder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">folder</span><span class="p">,</span>
        <span class="n">name_pattern</span><span class="p">,</span>
        <span class="n">file_table</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">file_format</span><span class="o">=</span><span class="s2">&quot;tif&quot;</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_folder</span><span class="p">(</span>
            <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
            <span class="n">name_pattern</span><span class="o">=</span><span class="n">name_pattern</span><span class="p">,</span>
            <span class="n">file_table</span><span class="o">=</span><span class="n">file_table</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">file_format</span><span class="o">=</span><span class="n">file_format</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QualiRasterSeries.get_series_areas">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterSeries.get_series_areas">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_series_areas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get areas prevalance for all series</span>

<span class="sd">        :return: dataframe of series areas</span>
<span class="sd">        :rtype: :class:`pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># compute areas for each raster</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)):</span>
            <span class="n">s_raster_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">s_raster_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># compute</span>
            <span class="n">df_areas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">s_raster_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_areas</span><span class="p">()</span>
            <span class="c1"># insert name and date fields</span>
            <span class="n">df_areas</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_raster&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="n">s_raster_name</span>
            <span class="p">)</span>
            <span class="n">df_areas</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">s_raster_date</span><span class="p">)</span>
            <span class="c1"># concat dataframes</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df_areas_full</span> <span class="o">=</span> <span class="n">df_areas</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_areas_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_areas_full</span><span class="p">,</span> <span class="n">df_areas</span><span class="p">])</span>
        <span class="n">df_areas_full</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_areas_full</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="s2">&quot;category&quot;</span>
        <span class="p">)</span>
        <span class="n">df_areas_full</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">df_areas_full</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># handle id for raster</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_raster&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">)</span>
        <span class="c1"># slice from areas</span>
        <span class="n">df_slice</span> <span class="o">=</span> <span class="n">df_areas_full</span><span class="p">[[</span><span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_slice</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_slice</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">field_name</span><span class="p">)</span>

        <span class="c1"># sort and reset</span>
        <span class="n">df_slice</span> <span class="o">=</span> <span class="n">df_slice</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_datetime</span><span class="p">)</span>
        <span class="n">df_slice</span> <span class="o">=</span> <span class="n">df_slice</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># create the id</span>
        <span class="n">field_id</span> <span class="o">=</span> <span class="s2">&quot;id_raster&quot;</span>
        <span class="n">df_slice</span><span class="p">[</span><span class="n">field_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_slice</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">df_slice</span> <span class="o">=</span> <span class="n">df_slice</span><span class="p">[[</span><span class="n">field_id</span><span class="p">,</span> <span class="n">field_name</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">ls_old_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_areas_full</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">ls_new_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">ls_old_columns</span>

        <span class="c1"># merge</span>
        <span class="n">df_areas_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="n">df_areas_full</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">df_slice</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
        <span class="p">)</span>
        <span class="c1"># organize</span>
        <span class="n">df_areas_full</span> <span class="o">=</span> <span class="n">df_areas_full</span><span class="p">[</span><span class="n">ls_new_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df_areas_full</span></div>


    <span class="c1"># todo [refactor]</span>
<div class="viewcode-block" id="QualiRasterSeries.view_series_areas">
<a class="viewcode-back" href="../../../generated/plans.datasets.core.html#plans.datasets.core.QualiRasterSeries.view_series_areas">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">view_series_areas</span><span class="p">(</span>
        <span class="n">df_table</span><span class="p">,</span>
        <span class="n">df_areas</span><span class="p">,</span>
        <span class="n">specs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">export_areas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;./output&quot;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">fig_format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        View series areas</span>

<span class="sd">        :param specs: specifications dictionary, defaults to None</span>
<span class="sd">        :type specs: dict</span>
<span class="sd">        :param show: option to show plot instead of saving, defaults to False</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param folder: path to output folder, defaults to ``./output``</span>
<span class="sd">        :type folder: str</span>
<span class="sd">        :param filename: name of file, defaults to None</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param dpi: image resolution, defaults to 96</span>
<span class="sd">        :type dpi: int</span>
<span class="sd">        :param fig_format: image fig_format (ex: png or jpg). Default jpg</span>
<span class="sd">        :type fig_format: str</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get specs</span>
        <span class="n">default_specs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Area Series&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="mf">1.618</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;ylabel&quot;</span><span class="p">:</span> <span class="s2">&quot;Area prevalence (%)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="s2">&quot;xlim&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;legend_x&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
            <span class="s2">&quot;legend_y&quot;</span><span class="p">:</span> <span class="mf">0.33</span><span class="p">,</span>
            <span class="s2">&quot;legend_ncol&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;filter_by_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># list of ids</span>
            <span class="s2">&quot;annotate&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;annotate_by_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># handle inputs specs</span>
        <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># override default</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
                <span class="n">default_specs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="n">default_specs</span>

        <span class="c1"># Deploy figure</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]))</span>  <span class="c1"># Width, Height</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span>
            <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>

        <span class="c1"># start plotting</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_table</span><span class="p">)):</span>
            <span class="c1"># get attributes</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">df_table</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="n">df_table</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">_alias</span> <span class="o">=</span> <span class="n">df_table</span><span class="p">[</span><span class="s2">&quot;Alias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">_color</span> <span class="o">=</span> <span class="n">df_table</span><span class="p">[</span><span class="s2">&quot;Color&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># ploting</span>
            <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;filter_by_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># filter series</span>
                <span class="n">_df</span> <span class="o">=</span> <span class="n">df_areas</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id == </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_id</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;Area_%&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">_color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_id</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;filter_by_id&quot;</span><span class="p">]:</span>
                    <span class="c1"># filter series</span>
                    <span class="n">_df</span> <span class="o">=</span> <span class="n">df_areas</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Id == </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_id</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;Area_%&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">_color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">_name</span><span class="p">)</span>
                    <span class="c1"># annotate</span>
                    <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;annotate&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">_id</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;annotate_by_id&quot;</span><span class="p">]:</span>
                            <span class="n">lst_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">lst_areas</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;Area_%&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;Area_%&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="p">]</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                <span class="n">lst_dates</span><span class="p">,</span>
                                <span class="n">lst_areas</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">_color</span><span class="p">,</span>
                                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                                <span class="n">x</span><span class="o">=</span><span class="n">lst_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">y</span><span class="o">=</span><span class="n">lst_areas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
                                <span class="n">s</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lst_areas</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">_color</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                                <span class="n">x</span><span class="o">=</span><span class="n">lst_dates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">y</span><span class="o">=</span><span class="n">lst_areas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
                                <span class="n">s</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lst_areas</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">_color</span><span class="p">,</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
            <span class="n">markerscale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;legend_x&quot;</span><span class="p">],</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;legend_y&quot;</span><span class="p">]),</span>
            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span>
            <span class="n">ncol</span><span class="o">=</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;legend_ncol&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">df_areas</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_areas</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;ylabel&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xlim&quot;</span><span class="p">]:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">specs</span><span class="p">[</span><span class="s2">&quot;xlim&quot;</span><span class="p">]))</span>

        <span class="c1"># show or save</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;areas&quot;</span>
            <span class="c1"># save fig1</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fig_format</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="c1"># save areas</span>
            <span class="k">if</span> <span class="n">export_areas</span><span class="p">:</span>
                <span class="n">df_areas</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<span class="c1"># CLASSES -- Module-level</span>
<span class="c1"># =======================================================================</span>
<span class="c1"># ... {develop}</span>


<span class="c1"># SCRIPT</span>
<span class="c1"># ***********************************************************************</span>
<span class="c1"># standalone behaviour as a script</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># Script section</span>
    <span class="c1"># ===================================================================</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello world!&quot;</span><span class="p">)</span>
    <span class="c1"># ... {develop}</span>

    <span class="c1"># Script subsection</span>
    <span class="c1"># -------------------------------------------------------------------</span>
    <span class="c1"># ... {develop}</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2025, Ipor Possantti.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>